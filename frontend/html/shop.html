<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>F2C Solutions ‚Äî Marketplace</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link href="../styles/custom.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .marketplace-header {
      background: linear-gradient(135deg, #5a8a59 0%, #6b9c6d 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: 0 8px 25px rgba(90, 138, 89, 0.3);
    }
    
    .marketplace-header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2.5rem;
      font-weight: 700;
    }
    
    .marketplace-header p {
      margin: 0;
      opacity: 0.9;
      font-size: 1.1rem;
    }
    
    .product-card {
      background: white;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      margin-bottom: 1.5rem;
    }
    
    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .product-image {
      height: 120px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }
    
    .product-info {
      padding: 1.25rem;
    }
    
    .product-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 0.5rem;
    }
    
    .product-price {
      font-size: 1.25rem;
      font-weight: 700;
      color: #5a8a59;
      margin-bottom: 0.5rem;
    }
    
    .product-meta {
      font-size: 0.9rem;
      color: #718096;
      margin-bottom: 1rem;
    }
    
    .expiry-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .expiry-good { 
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
    }
    
    .expiry-warning { 
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
    }
    
    .expiry-danger { 
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
    }
    
    .cart-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .cart-empty {
      text-align: center;
      padding: 2rem;
      color: #718096;
    }
    
    .cart-total {
      background: linear-gradient(135deg, #5a8a59 0%, #6b9c6d 100%);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Primary navbar (loaded via component) -->
  <div id="navbar"></div>
  
  <!-- Fallback navbar (shown if component loading fails) -->
  <div id="navbar-fallback" style="display: none;">
    <nav class="main-navbar" style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; position: sticky; top: 0; z-index: 1000;">
      <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; min-height: 80px;">
        <div style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: #333;">
          <div style="width: 40px; height: 40px; background-color: #5a8a59; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">F2C</div>
          <div>
            <h1 style="font-size: 18px; font-weight: 700; color: #333; margin: 0;">F2C Solutions</h1>
            <p style="font-size: 12px; color: #666; margin: 0;">Farmer to Customer</p>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <a href="../html/dashboard.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Dashboard</a>
          <a href="../html/inventory.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Inventory</a>
          <a href="../html/analytics.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Analytics</a>
          <a href="../html/shop.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px; background-color: #5a8a59; color: white;">Marketplace</a>
          <a href="../html/tracking.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Orders</a>
          <a href="../html/auth.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Profile</a>
        </div>
      </div>
    </nav>
  </div>

  <main class="container my-4">
    <!-- Header -->
    <div class="marketplace-header">
      <h1><i class="fas fa-store me-3"></i>Farmers Marketplace</h1>
      <p>Browse fresh products directly from local farms</p>
    </div>

    <div class="row g-4">
      <!-- Products Section -->
      <div class="col-lg-8">
        <div class="card card-soft">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h4 mb-0">Available Products</h2>
              <button class="btn btn-outline-success" onclick="refreshMarketplace()">
                <i class="fas fa-sync me-2"></i>Refresh
              </button>
            </div>
            
            <div id="productsContainer">
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading marketplace items...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cart Section -->
      <div class="col-lg-4">
        <div class="card card-soft">
          <div class="card-body">
            <h3 class="h5 mb-3">
              <i class="fas fa-shopping-cart me-2"></i>Your Cart
            </h3>
            
            <div id="cartContainer">
              <div class="cart-empty">
                <i class="fas fa-cart-plus fa-2x mb-2"></i>
                <p>Your cart is empty</p>
                <small>Add items from the marketplace to get started</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/components.js"></script>
  <script src="../js/db.js"></script>
  <script>
    console.log('Loading navbar component...');
    
    // Load navbar component with error handling
    loadComponent("navbar", "../components/navbar.html").then(() => {
      console.log('Navbar component loaded successfully');
      // Hide fallback navbar if main navbar loaded successfully
      const fallback = document.getElementById('navbar-fallback');
      if (fallback) {
        fallback.style.display = 'none';
      }
    }).catch((error) => {
      console.error('Failed to load navbar component:', error);
      
      // Show fallback navbar
      const fallback = document.getElementById('navbar-fallback');
      if (fallback) {
        fallback.style.display = 'block';
        console.log('Fallback navbar shown');
      }
      
      // Try fallback method
      fetch('../components/navbar.html')
        .then(response => response.text())
        .then(html => {
          const navbarElement = document.getElementById('navbar');
          if (navbarElement) {
            navbarElement.innerHTML = html;
            console.log('Navbar loaded via fallback method');
            // Hide fallback navbar if successful
            const fallback = document.getElementById('navbar-fallback');
            if (fallback) {
              fallback.style.display = 'none';
            }
          }
        })
        .catch(fallbackError => {
          console.error('Fallback navbar loading failed:', fallbackError);
        });
    });

    // Initialize cart from localStorage
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    // Load marketplace when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadMarketplace();
      updateCart();
    });

    function loadMarketplace() {
      const marketplaceItems = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      const container = document.getElementById('productsContainer');
      
      if (marketplaceItems.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No products available</h5>
            <p class="text-muted">Farmers haven't listed any products yet. Check back later!</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      marketplaceItems.forEach(item => {
        const categoryEmoji = {
          'üåæ Grains & Seeds': 'üåæ',
          'üåø Herbs': 'üåø',
          'ü•¨ Vegetables': 'ü•¨',
          'ü•õ Dairy': 'ü•õ',
          'ü•© Meat': 'ü•©',
          'üêî Poultry': 'üêî',
          'üì¶ Other': 'üì¶'
        };
        
        const daysUntilExpiry = getDaysUntilExpiry(item.expiryDate);
        const expiryBadge = getExpiryBadge(daysUntilExpiry);
        
        html += `
          <div class="product-card">
            <div class="product-image">
              <span>${categoryEmoji[item.category] || 'üì¶'}</span>
            </div>
            <div class="product-info">
              <h5 class="product-title">${item.name}</h5>
              <div class="product-price">R${item.sellingPrice} per ${item.unit}</div>
              <div class="product-meta">
                <i class="fas fa-tag me-1"></i>${item.category}<br>
                <i class="fas fa-boxes me-1"></i>Available: ${item.quantity} ${item.unit}<br>
                <small class="text-muted">
                  Seller: ${window.F2CDB && F2CDB.getCurrentUser && item.owner ? (item.owner === F2CDB.getCurrentUser() ? 'You' : item.owner) : (item.owner || 'Unknown')}
                </small>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                ${expiryBadge}
                <div class="d-flex align-items-center">
                  <input type="number" class="form-control form-control-sm me-2" 
                         id="qty-${item.id}" value="1" min="1" max="${item.quantity}" 
                         style="width: 80px;">
                  <button class="btn btn-success btn-sm" onclick="addToCart(${item.id})">
                    <i class="fas fa-plus me-1"></i>Add
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function addToCart(itemId) {
      const marketplaceItems = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      const item = marketplaceItems.find(i => i.id == itemId);
      
      if (!item) {
        showToast('Product not found', 'error');
        return;
      }
      
      const quantityInput = document.getElementById(`qty-${itemId}`);
      const quantity = parseInt(quantityInput.value);
      
      if (quantity > item.quantity) {
        showToast('Not enough stock available', 'error');
        return;
      }
      
      // Check if item already in cart
      const existingItem = cart.find(cartItem => cartItem.id == itemId);
      
      if (existingItem) {
        existingItem.quantity += quantity;
        if (existingItem.quantity > item.quantity) {
          existingItem.quantity = item.quantity;
          showToast('Max quantity reached', 'warning');
        }
      } else {
        cart.push({
          id: item.id,
          name: item.name,
          price: item.sellingPrice,
          unit: item.unit,
          quantity: quantity,
          maxQuantity: item.quantity
        });
      }
      
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
      showToast(`Added ${quantity} ${item.name} to cart`, 'success');
      
      // Reset quantity input
      quantityInput.value = 1;
    }

    function updateCart() {
      const container = document.getElementById('cartContainer');
      
      if (cart.length === 0) {
        container.innerHTML = `
          <div class="cart-empty">
            <i class="fas fa-cart-plus fa-2x mb-2"></i>
            <p>Your cart is empty</p>
            <small>Add items from the marketplace to get started</small>
          </div>
        `;
        updateCartTotal(0);
        return;
      }
      
      let html = '';
      let total = 0;
      
      cart.forEach((item, index) => {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        
        html += `
          <div class="cart-item">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <strong>${item.name}</strong><br>
                <small class="text-muted">R${item.price} per ${item.unit}</small>
              </div>
              <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <div class="input-group input-group-sm" style="width: 100px;">
                <button class="btn btn-outline-secondary" onclick="updateCartQuantity(${index}, -1)">-</button>
                <input type="number" class="form-control text-center" value="${item.quantity}" 
                       min="1" max="${item.maxQuantity}" 
                       onchange="updateCartQuantityDirect(${index}, this.value)">
                <button class="btn btn-outline-secondary" onclick="updateCartQuantity(${index}, 1)">+</button>
              </div>
                  <strong>R${subtotal.toFixed(2)}</strong>
            </div>
          </div>
        `;
      });
      
      html += `
            <div class="cart-total">
          <div class="d-flex justify-content-between">
            <span>Total:</span>
            <span class="fs-5 fw-bold">R${total.toFixed(2)}</span>
          </div>
        </div>
        <div class="d-grid gap-2">
          <button class="btn btn-success" onclick="checkout()">
            <i class="fas fa-credit-card me-2"></i>Checkout
          </button>
          <button class="btn btn-outline-secondary" onclick="clearCart()">
            <i class="fas fa-trash me-2"></i>Clear Cart
          </button>
        </div>
      `;
      
      container.innerHTML = html;
      updateCartTotal(total);
    }

    function updateCartQuantity(index, change) {
      const item = cart[index];
      const newQuantity = item.quantity + change;
      
      if (newQuantity < 1 || newQuantity > item.maxQuantity) {
        return;
      }
      
      item.quantity = newQuantity;
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
    }

    function updateCartQuantityDirect(index, newQuantity) {
      newQuantity = parseInt(newQuantity);
      const item = cart[index];
      
      if (newQuantity < 1 || newQuantity > item.maxQuantity) {
        updateCart(); // Reset to valid value
        return;
      }
      
      item.quantity = newQuantity;
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
      showToast('Item removed from cart', 'info');
    }

    function clearCart() {
      if (cart.length === 0) return;
      
      if (confirm('Are you sure you want to clear your cart?')) {
        cart = [];
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCart();
        showToast('Cart cleared', 'info');
      }
    }

    function checkout() {
      if (cart.length === 0) {
        showToast('Your cart is empty', 'warning');
        return;
      }
      
      const customerName = prompt('Please enter your name:');
      if (!customerName) return;
      
      const customerEmail = prompt('Please enter your email:');
      if (!customerEmail) return;
      
      const shippingAddress = prompt('Please enter your shipping address:');
      if (!shippingAddress) return;
      
      // Create order ‚Äî include marketplace item id and owner for accurate attribution
      const _marketplace = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      // Normalize order shape to match Orders/Tracking page expectations
      const order = {
        id: Date.now(),
        date: new Date().toISOString(),
        customer: {
          name: customerName,
          email: customerEmail,
          phone: ''
        },
        items: cart.map(item => {
          const match = _marketplace.find(m => String(m.id) === String(item.id) || (m.name === item.name && m.unit === item.unit));
          return {
            id: item.id || (match && match.id) || null,
            owner: match ? match.owner || null : null,
            name: item.name,
            quantity: item.quantity,
            price: item.price,
            unit: item.unit
          };
        }),
        total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
        status: 'pending',
        shippingAddress: shippingAddress
      };
      
      // Save order (use the shared 'orders' key)
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      orders.push(order);
      localStorage.setItem('orders', JSON.stringify(orders));

      // Broadcast an update so other parts of the app can react if needed
      try {
        const event = new Event('ordersUpdated');
        window.dispatchEvent(event);
      } catch (e) {
        // ignore
      }
      
      // Update inventory
      let marketplaceItems = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      cart.forEach(cartItem => {
        const itemIndex = marketplaceItems.findIndex(item => item.id == cartItem.id);
        if (itemIndex !== -1) {
          marketplaceItems[itemIndex].quantity -= cartItem.quantity;
          if (marketplaceItems[itemIndex].quantity <= 0) {
            marketplaceItems.splice(itemIndex, 1);
          }
        }
      });
      if (window.F2CDB) {
        F2CDB.writeMarketplace(marketplaceItems);
      } else {
        localStorage.setItem('marketplaceItems', JSON.stringify(marketplaceItems));
      }
      
      // Clear cart
      cart = [];
      localStorage.setItem('cart', JSON.stringify(cart));
      
      // Update displays
      updateCart();
      loadMarketplace();
      
      showToast('Order placed successfully!', 'success');
      alert(`Order #${order.id} has been placed successfully!\n\nYou will receive a confirmation email shortly.`);
    }

    function refreshMarketplace() {
      loadMarketplace();
      showToast('Marketplace refreshed', 'info');
    }

    function updateCartTotal(total) {
      // This function can be used to update cart total in other parts of the UI if needed
    }

    function getDaysUntilExpiry(expiryDate) {
      if (!expiryDate) return Infinity;
      const today = new Date();
      const expiry = new Date(expiryDate);
      const timeDiff = expiry - today;
      return Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
    }

    function getExpiryBadge(days) {
      if (days === Infinity) return '<span class="expiry-badge expiry-good">No expiry</span>';
      if (days < 0) return `<span class="expiry-badge expiry-danger">Expired ${Math.abs(days)} days ago</span>`;
      if (days <= 3) return `<span class="expiry-badge expiry-danger">Expires in ${days} days</span>`;
      if (days <= 7) return `<span class="expiry-badge expiry-warning">Expires in ${days} days</span>`;
      return `<span class="expiry-badge expiry-good">Expires in ${days} days</span>`;
    }

    function showToast(message, type = 'success') {
      const toastContainer = document.getElementById('toastContainer');
      const toastId = 'toast-' + Date.now();
      
      const bgClass = {
        'success': 'bg-success',
        'error': 'bg-danger',
        'info': 'bg-info',
        'warning': 'bg-warning'
      }[type] || 'bg-success';
      
      const icon = {
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-circle',
        'info': 'fa-info-circle',
        'warning': 'fa-exclamation-triangle'
      }[type] || 'fa-check-circle';
      
      const toast = document.createElement('div');
      toast.innerHTML = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">
              <i class="fas ${icon} me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;
      
      toastContainer.appendChild(toast.firstElementChild);
      const bsToast = new bootstrap.Toast(document.getElementById(toastId));
      bsToast.show();
      
      // Clean up after toast is hidden
      document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
        this.remove();
      });
    }
  </script>
</body>
</html>