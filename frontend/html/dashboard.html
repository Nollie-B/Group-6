<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link href="../styles/custom.css" rel="stylesheet" />
  <style>
    .dashboard-metric {
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .dashboard-metric:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #343a40;
      margin: 0;
      line-height: 1;
    }
    
    .metric-label {
      font-size: 0.875rem;
      color: #6c757d;
      margin-top: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .metric-trend {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .trend-up {
      background-color: #d4edda;
      color: #155724;
    }
    
    .trend-down {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      border: 1px solid #e9ecef;
      height: 400px;
      position: relative;
    }
    
    .chart-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #343a40;
      margin-bottom: 16px;
    }
    
    .activity-item {
      padding: 12px 0;
      border-bottom: 1px solid #f1f3f4;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .activity-icon.success {
      background-color: #d4edda;
      color: #155724;
    }
    
    .activity-icon.info {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    
    .activity-icon.warning {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .alert-card {
      background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
      border: 1px solid #fed7d7;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    
    .alert-title {
      font-weight: 600;
      color: #c53030;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    
    .alert-description {
      font-size: 0.8rem;
      color: #718096;
      margin: 0;
    }
    
    .quick-action-card {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: block;
    }
    
    .quick-action-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      text-decoration: none;
      color: inherit;
    }
    
    .quick-action-icon {
      font-size: 2rem;
      margin-bottom: 12px;
      color: #5a8a59;
    }
    
    .quick-action-title {
      font-weight: 600;
      color: #343a40;
      margin-bottom: 4px;
    }
    
    .quick-action-desc {
      font-size: 0.8rem;
      color: #6c757d;
      margin: 0;
    }
    
    /* Weather widget styles removed */
  </style>
</head>
<body>
  <!-- Primary navbar (loaded via component) -->
  <div id="navbar"></div>
  
  <!-- Fallback navbar (shown if component loading fails) -->
  <div id="navbar-fallback" style="display: none;">
    <nav class="main-navbar" style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; position: sticky; top: 0; z-index: 1000;">
      <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; min-height: 80px;">
        <div style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: #333;">
          <div style="width: 40px; height: 40px; background-color: #5a8a59; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">F2C</div>
          <div>
            <h1 style="font-size: 18px; font-weight: 700; color: #333; margin: 0;">F2C Solutions</h1>
            <p style="font-size: 12px; color: #666; margin: 0;">Farmer to Customer</p>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <a href="../html/dashboard.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px; background-color: #5a8a59; color: white;">Dashboard</a>
          <a href="../html/inventory.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Inventory</a>
          <a href="../html/analytics.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Analytics</a>
          <a href="../html/shop.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Marketplace</a>
          <a href="../html/tracking.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Orders</a>
          <a href="../html/auth.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Profile</a>
        </div>
      </div>
    </nav>
  </div>

  <main class="container-fluid py-4">
    <!-- Welcome Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="h2 mb-1">Dashboard</h1>
            <p class="text-muted mb-0">Welcome back! Here's what's happening with your farm today.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Key Metrics (dynamic, per-user) -->
    <div class="row g-4 mb-4">
      <div class="col-lg-4 col-md-6">
        <div class="dashboard-metric">
          <div class="metric-trend trend-up">
            <i class="fas fa-arrow-up me-1"></i>
            <span id="monthlyTrend">0%</span>
          </div>
          <div class="metric-value" id="monthlyRevenue">R0</div>
          <div class="metric-label">Monthly Revenue</div>
        </div>
      </div>
      <div class="col-lg-4 col-md-6">
        <div class="dashboard-metric">
          <div class="metric-trend trend-up">
            <i class="fas fa-arrow-up me-1"></i>
            <span id="activeOrdersTrend">0%</span>
          </div>
          <div class="metric-value" id="activeOrders">0</div>
          <div class="metric-label">Active Orders</div>
        </div>
      </div>
      <div class="col-lg-4 col-md-6">
        <div class="dashboard-metric">
          <div class="metric-trend trend-down">
            <i class="fas fa-arrow-down me-1"></i>
            <span id="lowStockTrend">0%</span>
          </div>
          <div class="metric-value" id="lowStockItems">0</div>
          <div class="metric-label">Low Stock Items</div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Revenue Chart -->
      <div class="col-lg-8">
        <div class="chart-container">
          <div class="chart-title">Revenue Overview</div>
          <canvas id="revenueChart"></canvas>
        </div>
      </div>
      
      <!-- Alerts + other right-column content -->
      <div class="col-lg-4">
        <!-- Alerts -->
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-exclamation-triangle text-warning me-2"></i>
              Alerts
            </h5>
            
            <div id="alertsContainer">
              <!-- Alerts will be populated dynamically by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-2">
      <!-- Sales by Product -->
      <div class="col-lg-6">
        <div class="chart-container">
          <div class="chart-title">Sales by Product Category</div>
          <canvas id="productChart"></canvas>
        </div>
      </div>
      
      <!-- Recent Activity -->
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-clock text-info me-2"></i>
              Recent Activity
            </h5>
            
            <div class="activity-item">
              <div class="activity-icon success">
                <i class="fas fa-check"></i>
              </div>
              <div>
                <div class="fw-bold">Order Delivered</div>
                <small class="text-muted">Organic vegetables to Green Valley Market</small>
              </div>
            </div>
            
            <div class="activity-item">
              <div class="activity-icon info">
                <i class="fas fa-plus"></i>
              </div>
              <div>
                <div class="fw-bold">New Product Added</div>
                <small class="text-muted">Fresh Basil - 50 units added to inventory</small>
              </div>
            </div>
            
            <div class="activity-item">
              <div class="activity-icon success">
                <i class="fas fa-coins"></i>
              </div>
              <div>
                <div class="fw-bold">Payment Received</div>
                <small class="text-muted">R189.50 from Customer #34</small>
              </div>
            </div>
            
            <div class="activity-item">
              <div class="activity-icon warning">
                <i class="fas fa-exclamation"></i>
              </div>
              <div>
                <div class="fw-bold">Low Stock Warning</div>
                <small class="text-muted">Carrots at 8 units - restock needed</small>
              </div>
            </div>
            
            <div class="activity-item">
              <div class="activity-icon info">
                <i class="fas fa-star"></i>
              </div>
              <div>
                <div class="fw-bold">5-Star Review</div>
                <small class="text-muted">"Amazing fresh produce quality!"</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Demand Forecast Prototype -->
    <div class="row g-4 mt-4">
      <div class="col-12">
        <div class="chart-container">
          <div class="chart-title">Demand Forecast</div>
          <div class="row">
            <div class="col-lg-8">
              <canvas id="demandChart" style="height:220px;"></canvas>
            </div>
            <div class="col-lg-4">
              <div id="demandSummary">
                <h6>Next 7 days forecast</h6>
                <div class="metric-value" id="forecastTotal">—</div>
                <p class="text-muted" id="forecastConfidence">Confidence: —</p>
                <p class="text-muted"><small>Updated: <span id="demandLastUpdated">-</span></small></p>
                <button class="btn btn-sm btn-outline-secondary" id="refreshDemandBtn">Refresh Now</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mt-4">
      <div class="col-12">
        <h5 class="mb-3">Quick Actions</h5>
      </div>
      <div class="col-lg-2 col-md-4 col-6">
        <a href="inventory.html" class="quick-action-card">
          <div class="quick-action-icon">
            <i class="fas fa-boxes"></i>
          </div>
          <div class="quick-action-title">Manage Inventory</div>
          <p class="quick-action-desc">Add, edit, or remove products</p>
        </a>
      </div>
      <div class="col-lg-2 col-md-4 col-6">
        <a href="shop.html" class="quick-action-card">
          <div class="quick-action-icon">
            <i class="fas fa-store"></i>
          </div>
          <div class="quick-action-title">Marketplace</div>
          <p class="quick-action-desc">View your online store</p>
        </a>
      </div>
      <div class="col-lg-2 col-md-4 col-6">
        <a href="tracking.html" class="quick-action-card">
          <div class="quick-action-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="quick-action-title">Analytics</div>
          <p class="quick-action-desc">View detailed reports</p>
        </a>
      </div>
      <div class="col-lg-2 col-md-4 col-6">
        <a href="tracking.html" class="quick-action-card">
          <div class="quick-action-icon">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <div class="quick-action-title">Orders</div>
          <p class="quick-action-desc">Manage customer orders</p>
        </a>
      </div>
      <div class="col-lg-2 col-md-4 col-6">
        <a href="#" class="quick-action-card">
          <div class="quick-action-icon">
            <i class="fas fa-camera"></i>
          </div>
          <div class="quick-action-title">Upload Photos</div>
          <p class="quick-action-desc">Add product images</p>
        </a>
      </div>
      <div class="col-lg-2 col-md-4 col-6">
        <a href="auth.html" class="quick-action-card">
          <div class="quick-action-icon">
            <i class="fas fa-user-cog"></i>
          </div>
          <div class="quick-action-title">Profile</div>
          <p class="quick-action-desc">Manage your account</p>
        </a>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../js/components.js"></script>
  <script src="../js/db.js"></script>
  <script>
    console.log('Loading navbar component...');
    
    // Load navbar component with error handling
    loadComponent("navbar", "../components/navbar.html").then(() => {
      console.log('Navbar component loaded successfully');
      // Hide fallback navbar if main navbar loaded successfully
      const fallback = document.getElementById('navbar-fallback');
      if (fallback) {
        fallback.style.display = 'none';
      }
    }).catch((error) => {
      console.error('Failed to load navbar component:', error);
      
      // Show fallback navbar
      const fallback = document.getElementById('navbar-fallback');
      if (fallback) {
        fallback.style.display = 'block';
        console.log('Fallback navbar shown');
      }
      
      // Try fallback method
      fetch('../components/navbar.html')
        .then(response => response.text())
        .then(html => {
          const navbarElement = document.getElementById('navbar');
          if (navbarElement) {
            navbarElement.innerHTML = html;
            console.log('Navbar loaded via fallback method');
            // Hide fallback navbar if successful
            const fallback = document.getElementById('navbar-fallback');
            if (fallback) {
              fallback.style.display = 'none';
            }
          }
        })
        .catch(fallbackError => {
          console.error('Fallback navbar loading failed:', fallbackError);
        });
    });

    // Dashboard data helpers
    function getCurrentUser() {
      if (window.F2CDB && typeof F2CDB.getCurrentUser === 'function') return F2CDB.getCurrentUser();
      return localStorage.getItem('pp_loggedInUser') || null;
    }

    function readOrders() {
      try { return JSON.parse(localStorage.getItem('orders')) || []; } catch (e) { return []; }
    }

    function formatCurrency(n) {
      return 'R' + (n || 0).toFixed(2);
    }

    // Compute per-user metrics and update UI
    function updateDashboardMetrics() {
      const user = getCurrentUser();
      const inventory = window.F2CDB ? F2CDB.readInventory() : (JSON.parse(localStorage.getItem('inventory')) || []);
      const marketplace = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      const orders = readOrders();

      // Revenue per month for items sold by this user
      const monthlyData = Array(12).fill(0);
      let totalRevenue = 0;
      let userOrderCount = 0;

      if (user && orders.length) {
        orders.forEach(order => {
          const orderMonth = new Date(order.orderDate || order.date || Date.now()).getMonth();
          // check if order contains products from this user's marketplace listings
          let orderHasUserItem = false;
          (order.products || order.items || []).forEach(p => {
            // Try to match marketplace item by id or name
            let matched = null;
            if (p.id) matched = marketplace.find(m => String(m.id) === String(p.id));
            if (!matched) matched = marketplace.find(m => m.name === p.name && m.owner === user);
            if (matched && matched.owner === user) {
              const lineTotal = (p.price || p.sellingPrice || 0) * (p.quantity || 0);
              monthlyData[orderMonth] += lineTotal;
              totalRevenue += lineTotal;
              orderHasUserItem = true;
            }
          });
          if (orderHasUserItem) userOrderCount++;
        });
      }

      // Active orders: number of orders including this user's items (pending/confirmed)
      const activeOrders = userOrderCount;

      // Low stock: inventory items for this user below threshold
      const lowStockThreshold = 10;
      const lowStockCount = (inventory.filter(i => (i.quantity || 0) <= lowStockThreshold)).length;

      // Update DOM
      const monthlyEl = document.getElementById('monthlyRevenue');
      const activeEl = document.getElementById('activeOrders');
      const lowStockEl = document.getElementById('lowStockItems');
      if (monthlyEl) monthlyEl.textContent = formatCurrency(totalRevenue);
      if (activeEl) activeEl.textContent = activeOrders;
      if (lowStockEl) lowStockEl.textContent = lowStockCount;

      // Update revenue chart using computed monthlyData
      const revenueCtx = document.getElementById('revenueChart').getContext('2d');
      if (window._f2cRevenueChart) {
        window._f2cRevenueChart.data.datasets[0].data = monthlyData;
        window._f2cRevenueChart.update();
      } else {
        window._f2cRevenueChart = new Chart(revenueCtx, {
          type: 'line',
          data: {
            labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
            datasets: [{
              label: 'Revenue',
              data: monthlyData,
              borderColor: '#5a8a59',
              backgroundColor: 'rgba(90, 138, 89, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4
            }]
          },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { callback: function(v){ return 'R' + v.toLocaleString(); } } } }
          }
        });
      }

      // Spoilage alerts: replace existing logic to use per-user inventory
      try { if (typeof loadSpoilageAlerts === 'function') loadSpoilageAlerts(); } catch(e) {}
    }

    // Run metrics update on load and when storage changes
    document.addEventListener('DOMContentLoaded', function() {
      updateDashboardMetrics();
    });

    window.addEventListener('storage', function() {
      // update metrics if another tab changed data
      updateDashboardMetrics();
    });

    // Also refresh metrics when the page/tab becomes visible or receives focus
    // This covers cases where the user navigates away and returns without a full reload.
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') updateDashboardMetrics();
    });

    window.addEventListener('focus', function() {
      updateDashboardMetrics();
    });

    // pageshow handles bfcache/Back-Forward Cache restores in some browsers
    window.addEventListener('pageshow', function() {
      updateDashboardMetrics();
    });

    // Listen for custom events from in-page loaders or nav components
    document.addEventListener('f2c:show-dashboard', function() {
      updateDashboardMetrics();
    });

    // Listen for ordersUpdated to refresh dashboard metrics in-page
    window.addEventListener('ordersUpdated', function() {
      updateDashboardMetrics();
    });

    document.addEventListener('f2c:component-loaded', function(e) {
      try {
        const path = (e && e.detail && e.detail.componentPath) || '';
        if (path && (path.indexOf('dashboard') !== -1 || path.indexOf('index') !== -1)) {
          updateDashboardMetrics();
        }
      } catch (err) {}
    });

    // Load dynamic alerts (low-stock + recent orders for current user)
    function loadSpoilageAlerts() {
      const alertsList = document.getElementById('alertsContainer');
      if (!alertsList) return;

      const user = getCurrentUser();
      const inventory = window.F2CDB ? F2CDB.readInventory() : (JSON.parse(localStorage.getItem('inventory')) || []);
      const marketplace = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      const orders = readOrders();

      const lowStockThreshold = 10;
      const lowStock = (inventory || []).filter(i => (i.quantity || 0) <= lowStockThreshold);

      // Expiry-based alerts: inventory items and marketplace listings expiring soon
      const expiryWindowDays = 7; // show warnings for items expiring within 7 days
      const urgentDays = 3; // urgent if <= 3 days
      function daysUntil(dateStr) {
        if (!dateStr) return Infinity;
        const d = new Date(dateStr);
        if (isNaN(d)) return Infinity;
        const diff = (d - new Date()) / (1000 * 60 * 60 * 24);
        return Math.ceil(diff);
      }

      const expiringInventory = (inventory || []).filter(i => {
        const days = daysUntil(i.expiry || i.expiryDate || i.expiryDateString);
        return days <= expiryWindowDays;
      }).map(i => ({ item: i, days: daysUntil(i.expiry || i.expiryDate || i.expiryDateString) }));

      // Also check marketplace listings owned by this user for expiryDate
      const expiringListings = (marketplace || []).filter(m => m.owner === user).filter(m => {
        const days = daysUntil(m.expiryDate || m.expiry);
        return days <= expiryWindowDays;
      }).map(m => ({ item: m, days: daysUntil(m.expiryDate || m.expiry) }));

      // Recent orders that include this user's marketplace items
      const recentOrders = (orders || []).slice().reverse().filter(order => {
        const lines = (order.products || order.items || []);
        return lines.some(p => {
          let matched = null;
          if (p.id) matched = (marketplace || []).find(m => String(m.id) === String(p.id));
          if (!matched) matched = (marketplace || []).find(m => m.name === p.name && m.owner === user);
          return matched && matched.owner === user;
        });
      }).slice(0, 3);

      let html = '';

      // Build alert list: low stock, expiring inventory/listings, recent orders
      if (lowStock.length === 0 && expiringInventory.length === 0 && expiringListings.length === 0 && recentOrders.length === 0) {
        html = '<div class="alert-card"><div class="alert-title">All Clear</div><p class="alert-description">No low-stock, expiring items, or recent orders affecting your listings.</p></div>';
      } else {
        // Low stock alerts
        lowStock.forEach(item => {
          html += '<div class="alert-card">'
               +     '<div class="alert-title">Low Stock: ' + escapeHtml(item.name) + '</div>'
               +     '<p class="alert-description">' + (item.quantity || 0) + ' ' + (item.unit || '') + ' remaining — consider restocking.</p>'
               + '</div>';
        });

        // Expiry alerts for inventory
        expiringInventory.forEach(entry => {
          const item = entry.item;
          const d = entry.days;
          const urgency = d <= urgentDays ? ' (Urgent)' : ' (Expires soon)';
          html += '<div class="alert-card">'
               +     '<div class="alert-title">Expiry' + urgency + ': ' + escapeHtml(item.name) + '</div>'
               +     '<p class="alert-description">Expires in ' + (d === Infinity ? 'unknown' : d + ' day' + (d !== 1 ? 's' : '')) + ' — take action to sell or protect.</p>'
               + '</div>';
        });

        // Expiry alerts for marketplace listings
        expiringListings.forEach(entry => {
          const item = entry.item;
          const d = entry.days;
          const urgency = d <= urgentDays ? ' (Urgent)' : ' (Expires soon)';
          html += '<div class="alert-card">'
               +     '<div class="alert-title">Listing Expiry' + urgency + ': ' + escapeHtml(item.name) + '</div>'
               +     '<p class="alert-description">Listing expires in ' + (d === Infinity ? 'unknown' : d + ' day' + (d !== 1 ? 's' : '')) + ' — consider relisting or adjusting price.</p>'
               + '</div>';
        });

        // Recent orders
        recentOrders.forEach(order => {
          const relevant = (order.products || order.items || []).filter(p => {
            let matched = null;
            if (p.id) matched = (marketplace || []).find(m => String(m.id) === String(p.id));
            if (!matched) matched = (marketplace || []).find(m => m.name === p.name && m.owner === user);
            return matched && matched.owner === user;
          });

          const productsText = relevant.map(p => escapeHtml(p.name) + ' x' + (p.quantity || 0)).join(', ');

          html += '<div class="alert-card">'
               +     '<div class="alert-title">New Order Received</div>'
               +     '<p class="alert-description">Order #' + order.id + ' contains your products: ' + productsText + '</p>'
               + '</div>';
        });
      }

      alertsList.innerHTML = html;
    }

    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Ensure alerts load on initial load as well
    document.addEventListener('DOMContentLoaded', function() {
      loadSpoilageAlerts();
    });

    // --- Demand Forecast (Prototype) ---
    function computeDailyDemand(orders, marketplace, user, daysBack = 30) {
      const counts = {};
      const today = new Date();
      for (let i = 0; i < daysBack; i++) {
        const d = new Date();
        d.setDate(today.getDate() - (daysBack - 1 - i));
        const key = d.toISOString().slice(0,10);
        counts[key] = 0;
      }

      (orders || []).forEach(order => {
        const dateStr = (order.orderDate || order.date || order.order_date || order.createdAt);
        const d = dateStr ? new Date(dateStr) : null;
        if (!d || isNaN(d)) return;
        const key = d.toISOString().slice(0,10);
        if (!(key in counts)) return; // out of window

        const lines = (order.products || order.items || []);
        lines.forEach(p => {
          let matched = null;
          if (p.id) matched = (marketplace || []).find(m => String(m.id) === String(p.id));
          if (!matched) matched = (marketplace || []).find(m => m.name === p.name && m.owner === user);
          if (matched && matched.owner === user) {
            counts[key] += (p.quantity || 0);
          }
        });
      });

      const labels = Object.keys(counts);
      const data = labels.map(l => counts[l] || 0);
      return { labels, data };
    }

    function buildForecastFromHistory(historyData, horizon = 7) {
      // Simple linear trend + moving average prototype
      const data = historyData.slice();
      const n = data.length;
      if (n === 0) return { forecast: Array(horizon).fill(0), total: 0, confidence: 0 };

      // moving average of last 7 days
      const maWindow = Math.min(7, n);
      const lastMA = data.slice(n - maWindow).reduce((s,v) => s+v,0) / maWindow;

      // simple slope (linear) between first and last
      const slope = (data[n-1] - data[0]) / Math.max(1, n-1);

      const forecast = [];
      for (let i = 1; i <= horizon; i++) {
        // project as lastMA plus slope * i
        const v = Math.max(0, Math.round(lastMA + slope * i));
        forecast.push(v);
      }

      const total = forecast.reduce((s,v) => s+v, 0);
      // rudimentary confidence: inverse of variance relative to mean
      const mean = data.reduce((s,v) => s+v,0) / n;
      const variance = data.reduce((s,v) => s + Math.pow(v - mean, 2), 0) / Math.max(1,n);
      const conf = mean === 0 ? 0 : Math.max(0, Math.round(Math.max(0, 100 - (variance / (mean+1)) * 10)));
      return { forecast, total, confidence: conf };
    }

    function loadDemandForecast() {
      const user = getCurrentUser();
      const marketplace = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      const orders = readOrders();

      const hist = computeDailyDemand(orders, marketplace, user, 30);
      const histLabels = hist.labels.map(l => l.slice(5)); // MM-DD
      const histData = hist.data;

      const f = buildForecastFromHistory(histData, 7);

      // Update summary
      const forecastTotalEl = document.getElementById('forecastTotal');
      const forecastConfEl = document.getElementById('forecastConfidence');
      const lastUpdatedEl = document.getElementById('demandLastUpdated');
      if (forecastTotalEl) forecastTotalEl.textContent = (f.total || 0) + ' items';
      if (forecastConfEl) forecastConfEl.textContent = 'Confidence: ' + (f.confidence || 0) + '%';
      if (lastUpdatedEl) lastUpdatedEl.textContent = new Date().toLocaleTimeString();

      // Create/Update chart
      const ctx = document.getElementById('demandChart').getContext('2d');
      const labels = histLabels.concat(Array.from({length: f.forecast.length}, (_,i) => '+' + (i+1)));
      const series = histData.concat(f.forecast);

      if (window._f2cDemandChart) {
        window._f2cDemandChart.data.labels = labels;
        window._f2cDemandChart.data.datasets[0].data = series;
        window._f2cDemandChart.data.datasets[1].data = Array(histData.length).fill(null).concat(f.forecast);
        window._f2cDemandChart.update();
      } else {
        window._f2cDemandChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Historical demand',
                data: histData.concat(Array(f.forecast.length).fill(null)),
                borderColor: '#4a90e2',
                backgroundColor: 'rgba(74,144,226,0.08)',
                fill: true,
                tension: 0.3
              },
              {
                label: 'Forecast (next 7 days)',
                data: Array(histData.length).fill(null).concat(f.forecast),
                borderColor: '#f39c12',
                backgroundColor: 'rgba(243,156,18,0.08)',
                borderDash: [6,4],
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }
    }

    // Wire refresh button and live updates
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById('refreshDemandBtn');
      if (btn) btn.addEventListener('click', loadDemandForecast);
      loadDemandForecast();
      // Poll every 8 seconds for prototype "real-time" feel
      setInterval(loadDemandForecast, 8000);
    });

    // Also refresh when storage or focus events occur
    window.addEventListener('storage', loadDemandForecast);
    window.addEventListener('focus', loadDemandForecast);

    // Product Sales Chart
    const productCtx = document.getElementById('productChart').getContext('2d');
    new Chart(productCtx, {
      type: 'doughnut',
      data: {
        labels: ['Vegetables', 'Fruits', 'Herbs', 'Dairy', 'Other'],
        datasets: [{
          data: [35, 25, 20, 15, 5],
          backgroundColor: [
            '#5a8a59',
            '#8bb17c',
            '#a8d4a3',
            '#c8e6c9',
            '#e8f5e9'
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
    
    // Add Product button removed — no action attached
  </script>
</body>
</html>