<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>F2C Solutions ‚Äî Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link href="../styles/custom.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .inventory-header {
      background: linear-gradient(135deg, #5a8a59 0%, #6b9c6d 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: 0 8px 25px rgba(90, 138, 89, 0.3);
    }
    
    .inventory-header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2.5rem;
      font-weight: 700;
    }
    
    .inventory-header p {
      margin: 0;
      opacity: 0.9;
      font-size: 1.1rem;
    }
    
    .form-card {
      background: white;
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    .form-card .card-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-bottom: 1px solid #e9ecef;
      padding: 1.5rem;
    }
    
    .form-card .card-body {
      padding: 2rem;
    }
    
    .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #5a8a59;
      box-shadow: 0 0 0 0.2rem rgba(90, 138, 89, 0.25);
    }
    
    .btn {
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #5a8a59 0%, #6b9c6d 100%);
      border: none;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #4a7a49 0%, #5a8a59 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(90, 138, 89, 0.4);
    }
    
    .btn-outline-secondary {
      border-color: #6c757d;
      color: #6c757d;
    }
    
    .btn-outline-secondary:hover {
      background-color: #6c757d;
      border-color: #6c757d;
      color: white;
    }
    
    .btn-outline-danger {
      border-color: #dc3545;
      color: #dc3545;
    }
    
    .btn-outline-danger:hover {
      background-color: #dc3545;
      border-color: #dc3545;
      color: white;
    }
    
    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
    
    .inventory-table {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .table {
      margin: 0;
    }
    
    .table thead th {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-bottom: 2px solid #e9ecef;
      font-weight: 600;
      color: #495057;
      padding: 1.2rem 1rem;
    }
    
    .table tbody td {
      padding: 1rem;
      vertical-align: middle;
      border-bottom: 1px solid #f1f3f4;
    }
    
    .table tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    .product-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      margin-right: 12px;
    }
    
    .category-grain { background-color: #ffeaa7; color: #b8860b; }
    .category-veg { background-color: #74b9ff; color: #0984e3; }
    .category-dairy { background-color: #a29bfe; color: #6c5ce7; }
    .category-meat { background-color: #fd79a8; color: #e84393; }
    .category-poultry { background-color: #fdcb6e; color: #e17055; }
    .category-herbs { background-color: #55efc4; color: #00b894; }
    .category-other { background-color: #b2bec3; color: #636e72; }
    
    .quantity-badge {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      color: #2e7d32;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    .price-chip {
      background: linear-gradient(135deg, #5a8a59 0%, #6b9c6d 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
    }
    
    .expiry-warning {
      color: #e17055;
      font-weight: 600;
    }
    
    .expiry-safe {
      color: #00b894;
    }
    
    .quick-list-card {
      background: white;
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    .quick-list-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
    }
    
    .quick-list-body {
      padding: 2rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }
    
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    
    .toast {
      border: none;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .alert-dismissible .btn-close {
      padding: 1rem;
    }
    
    .form-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .form-section-title {
      font-weight: 600;
      color: #495057;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .profit-indicator {
      font-weight: 600;
      margin-left: auto;
    }
    
    .profit-positive {
      color: #28a745;
    }
    
    .profit-negative {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <!-- Primary navbar (loaded via component) -->
  <div id="navbar"></div>
  
  <!-- Fallback navbar (shown if component loading fails) -->
  <div id="navbar-fallback" style="display: none;">
    <nav class="main-navbar" style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; position: sticky; top: 0; z-index: 1000;">
      <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; min-height: 80px;">
        <div style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: #333;">
          <div style="width: 40px; height: 40px; background-color: #5a8a59; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">F2C</div>
          <div>
            <h1 style="font-size: 18px; font-weight: 700; color: #333; margin: 0;">F2C Solutions</h1>
            <p style="font-size: 12px; color: #666; margin: 0;">Farmer to Customer</p>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <a href="../html/dashboard.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Dashboard</a>
          <a href="../html/inventory.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px; background-color: #5a8a59; color: white;">Inventory</a>
          <a href="../html/analytics.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Analytics</a>
          <a href="../html/shop.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Marketplace</a>
          <a href="../html/tracking.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Orders</a>
          <a href="../html/auth.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Profile</a>
        </div>
      </div>
    </nav>
  </div>

  <div class="container-fluid py-4">
    <!-- Header -->
    <div class="inventory-header">
      <h1><i class="fas fa-boxes me-3"></i>Inventory Management</h1>
      <p>Manage your farm products efficiently and quickly list them for sale</p>
    </div>

    <div class="row g-4">
      <!-- Add Inventory Form -->
      <div class="col-lg-8">
        <div class="form-card">
          <div class="card-header">
            <h2 class="h4 mb-0">
              <i class="fas fa-plus-circle me-2 text-success"></i>
              Add New Product
            </h2>
          </div>
          <div class="card-body">
            <form id="addInventoryForm" class="row g-3">
              <div class="col-12">
                <div class="form-section">
                  <div class="form-section-title">
                    <i class="fas fa-tag text-success"></i>
                    Product Information
                  </div>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Product name</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-apple-alt"></i></span>
                  <input
                    type="text"
                    name="name"
                    class="form-control"
                    placeholder="e.g. Organic Tomatoes"
                    required
                  />
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Category</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-list"></i></span>
                  <select name="category" class="form-select" required>
                    <option value="" disabled selected>Select category...</option>
                    <option value="Grain">üåæ Grain</option>
                    <option value="Veg">ü•¨ Vegetables</option>
                    <option value="Dairy">ü•õ Dairy</option>
                    <option value="Meat">ü•© Meat</option>
                    <option value="Poultry">üêî Poultry</option>
                    <option value="Herbs">üåø Herbs</option>
                    <option value="Other">üì¶ Other</option>
                  </select>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Unit</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-balance-scale"></i></span>
                  <select name="unit" class="form-select" required>
                    <option value="kg">kg (kilograms)</option>
                    <option value="g">g (grams)</option>
                    <option value="L">L (liters)</option>
                    <option value="ml">ml (milliliters)</option>
                    <option value="each">each</option>
                    <option value="dozen">dozen</option>
                    <option value="unit" selected>unit</option>
                  </select>
                </div>
              </div>

              <div class="col-12">
                <div class="form-section">
                  <div class="form-section-title">
                    <i class="fas fa-calculator text-info"></i>
                    Pricing & Quantity
                  </div>
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Quantity</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-sort-numeric-up"></i></span>
                  <input
                    type="number"
                    name="quantity"
                    min="1"
                    step="1"
                    value="1"
                    class="form-control"
                    required
                  />
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Selling Price (R)</label>
                <div class="input-group">
                  <span class="input-group-text">R</span>
                  <input
                    type="number"
                    name="price"
                    min="0"
                    step="0.01"
                    value="0"
                    class="form-control"
                    required
                  />
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Cost Price (R)</label>
                <div class="input-group">
                  <span class="input-group-text">R</span>
                  <input
                    type="number"
                    name="cost"
                    min="0"
                    step="0.01"
                    value="0"
                    class="form-control"
                    required
                  />
                </div>
                <div class="profit-indicator" id="profitIndicator"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Expiry date (optional)</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                  <input type="date" name="expiry" class="form-control" />
                </div>
              </div>

              <div class="col-12 d-flex gap-2">
                  <i class="fas fa-plus me-2"></i>Add to Inventory
                </button>
                <button type="button" class="btn btn-outline-secondary" id="sampleDataBtn">
                  <i class="fas fa-database me-2"></i>Add Sample Items
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Inventory Table -->
        <div class="mt-4">
          <div class="inventory-table">
            <div class="card-header">
              <h3 class="h5 mb-0">
                <i class="fas fa-list me-2 text-primary"></i>
                Current Inventory
                <span class="badge bg-success ms-2" id="itemCount">0 items</span>
              </h3>
            </div>
            <div class="card-body p-0">
              <div id="inventoryTableContainer">
                <div class="empty-state" id="emptyState">
                  <i class="fas fa-box-open"></i>
                  <h4>No items in inventory</h4>
                  <p>Start by adding your first product above</p>
                </div>
                <table class="table table-hover mb-0" id="inventoryTable" style="display: none;">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Category</th>
                      <th>Quantity</th>
                      <th>Price</th>
                      <th>Profit</th>
                      <th>Expiry</th>
                      <th class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="inventoryTableBody">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick List to Marketplace -->
      <div class="col-lg-4">
        <div class="quick-list-card">
          <div class="quick-list-header">
            <h3 class="h5 mb-0">
              <i class="fas fa-store me-2"></i>
              Quick List to Marketplace
            </h3>
            <p class="mb-0 mt-2 opacity-90">List items quickly for sale from your inventory</p>
          </div>
          <div class="quick-list-body">
            <form id="quickListForm" class="row g-3">
              <div class="col-12">
                <label class="form-label">Choose product</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-search"></i></span>
                  <select name="inventoryId" class="form-select" required>
                    <option value="" disabled selected>Select from inventory...</option>
                  </select>
                </div>
                <div id="productDetails" class="mt-2" style="display: none;"></div>
              </div>

              <div class="col-6">
                <label class="form-label">Quantity to list</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-sort-numeric-up"></i></span>
                  <input
                    type="number"
                    name="quantity"
                    min="1"
                    value="1"
                    class="form-control"
                    required
                  />
                </div>
              </div>

              <div class="col-6">
                <label class="form-label">Price per unit (R)</label>
                <div class="input-group">
                  <span class="input-group-text">R</span>
                  <input
                    type="number"
                    name="price"
                    min="0"
                    step="0.01"
                    class="form-control"
                    required
                  />
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Description (optional)</label>
                <textarea
                  name="description"
                  class="form-control"
                  rows="2"
                  placeholder="Add a brief description..."
                ></textarea>
              </div>

              <div class="col-12">
                <button type="submit" class="btn btn-primary w-100">
                  <i class="fas fa-store me-2"></i>List on Marketplace
                </button>
                <div class="text-center mt-2">
                  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearMarketplaceForm()">
                    <i class="fas fa-eraser me-1"></i>Clear Form
                  </button>
                </div>
              </div>
            </form>

            <hr class="my-4">

            <div class="text-center">
              <h6 class="mb-3">Quick Actions</h6>
              <button type="button" class="btn btn-outline-success btn-sm me-2" onclick="viewMarketplace()">
                <i class="fas fa-eye me-1"></i>View Marketplace
              </button>
              <button type="button" class="btn btn-outline-info btn-sm" onclick="viewAnalytics()">
                <i class="fas fa-chart-line me-1"></i>View Analytics
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/components.js"></script>
  <script src="../js/db.js"></script>
  <script>
    console.log('Loading navbar component...');
    
    // Load navbar component with error handling
    loadComponent("navbar", "../components/navbar.html").then(() => {
      console.log('Navbar component loaded successfully');
      // Hide fallback navbar if main navbar loaded successfully
      const fallback = document.getElementById('navbar-fallback');
      if (fallback) {
        fallback.style.display = 'none';
      }
    }).catch((error) => {
      console.error('Failed to load navbar component:', error);
      
      // Show fallback navbar
      const fallback = document.getElementById('navbar-fallback');
      if (fallback) {
        fallback.style.display = 'block';
        console.log('Fallback navbar shown');
      }
      
      // Try fallback method
      fetch('../components/navbar.html')
        .then(response => response.text())
        .then(html => {
          const navbarElement = document.getElementById('navbar');
          if (navbarElement) {
            navbarElement.innerHTML = html;
            console.log('Navbar loaded via fallback method');
            // Hide fallback navbar if successful
            const fallback = document.getElementById('navbar-fallback');
            if (fallback) {
              fallback.style.display = 'none';
            }
          }
        })
        .catch(fallbackError => {
          console.error('Fallback navbar loading failed:', fallbackError);
        });
    });

    // Data storage using F2CDB helpers (per-user inventory, shared marketplace)
    let inventory = window.F2CDB ? F2CDB.readInventory() : (JSON.parse(localStorage.getItem('inventory')) || []);
    let marketplaceItems = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      renderInventoryTable();
      updateQuickListOptions();
      setupEventListeners();
      updateItemCount();
    });

    // Event listeners
    function setupEventListeners() {
      // Add inventory form
      document.getElementById('addInventoryForm').addEventListener('submit', addInventoryItem);
      
      // Quick list form
      document.getElementById('quickListForm').addEventListener('submit', quickListItem);
      
      // Sample data button
      document.getElementById('sampleDataBtn').addEventListener('click', addSampleData);
      
      // Profit calculation
      document.querySelectorAll('#addInventoryForm input[name="price"], #addInventoryForm input[name="cost"]').forEach(input => {
        input.addEventListener('input', calculateProfit);
      });

      // Product selection in quick list
      document.querySelector('select[name="inventoryId"]').addEventListener('change', showProductDetails);
    }

    // Add inventory item
    function addInventoryItem(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const item = {
        id: Date.now(),
        name: formData.get('name'),
        category: formData.get('category'),
        unit: formData.get('unit'),
        quantity: parseInt(formData.get('quantity')),
        price: parseFloat(formData.get('price')),
        cost: parseFloat(formData.get('cost')),
        expiry: formData.get('expiry'),
        createdAt: new Date().toISOString()
      };

      // Add to inventory (per-user)
      inventory.push(item);
      if (window.F2CDB) {
        F2CDB.writeInventory(inventory);
      } else {
        localStorage.setItem('inventory', JSON.stringify(inventory));
      }

      // Show success toast
      showToast('success', `Added ${item.name} to inventory!`);
      
      // Reset form and update displays
      e.target.reset();
      document.getElementById('profitIndicator').innerHTML = '';
      renderInventoryTable();
      updateQuickListOptions();
      updateItemCount();
    }

    // Quick list item to marketplace
    function quickListItem(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const inventoryId = parseInt(formData.get('inventoryId'));
      const listingQuantity = parseInt(formData.get('quantity'));
      const listingPrice = parseFloat(formData.get('price'));
      const description = formData.get('description') || '';
      
      const inventoryItem = inventory.find(item => item.id === inventoryId);
      
      if (!inventoryItem) {
        showToast('danger', 'Selected product not found!');
        return;
      }

      // Validation
      if (isNaN(listingQuantity) || listingQuantity <= 0) {
        showToast('danger', 'Please enter a valid quantity!');
        return;
      }
      
      if (isNaN(listingPrice) || listingPrice <= 0) {
        showToast('danger', 'Please enter a valid price!');
        return;
      }

      // Check if quantity is available
      if (listingQuantity > inventoryItem.quantity) {
        showToast('danger', `Only ${inventoryItem.quantity} ${inventoryItem.unit} available in inventory!`);
        return;
      }

      // Check if already listed
      const existingListing = marketplaceItems.find(item => 
        item.originalInventoryId === inventoryId && item.name === inventoryItem.name
      );
      
      if (existingListing) {
        const proceed = confirm(`"${inventoryItem.name}" is already listed on the marketplace.\n\nCurrent listing: ${existingListing.quantity} ${inventoryItem.unit}\nDo you want to update the listing instead?`);
        
        if (proceed) {
          // Update existing listing
          const previousQuantity = existingListing.quantity;
          existingListing.quantity += listingQuantity;
          existingListing.sellingPrice = listingPrice;
          if (description) existingListing.description = description;
          existingListing.lastUpdated = new Date().toISOString();
          
          if (window.F2CDB) {
            F2CDB.writeMarketplace(marketplaceItems);
          } else {
            localStorage.setItem('marketplaceItems', JSON.stringify(marketplaceItems));
          }
          
          // Update inventory quantity
          inventoryItem.quantity -= listingQuantity;
          if (window.F2CDB) {
            F2CDB.writeInventory(inventory);
          } else {
            localStorage.setItem('inventory', JSON.stringify(inventory));
          }
          
          // Refresh the inventory table and other displays
          renderInventoryTable();
          updateItemCount();
          
          showToast('success', `Updated "${inventoryItem.name}" listing! Added ${listingQuantity} ${inventoryItem.unit}\nInventory updated: ${inventoryItem.quantity} ${inventoryItem.unit} remaining`);
        } else {
          return; // Don't add duplicate
        }
      } else {
        // Create new listing
        const listing = {
          id: Date.now(),
          name: inventoryItem.name,
          category: inventoryItem.category,
          unit: inventoryItem.unit,
          quantity: listingQuantity,
          costPrice: inventoryItem.costPrice || inventoryItem.sellingPrice || 0,
          sellingPrice: listingPrice,
          expiryDate: inventoryItem.expiryDate || null,
          description: description,
          originalInventoryId: inventoryId,
          createdAt: new Date().toISOString()
        };

        // Add to marketplace (mark owner)
        if (window.F2CDB) {
          listing = F2CDB.addMarketplaceListing(listing);
          marketplaceItems = F2CDB.readMarketplace();
        } else {
          marketplaceItems.push(listing);
          localStorage.setItem('marketplaceItems', JSON.stringify(marketplaceItems));
        }
        
        // Update inventory quantity
        inventoryItem.quantity -= listingQuantity;
        if (window.F2CDB) {
          F2CDB.writeInventory(inventory);
        } else {
          localStorage.setItem('inventory', JSON.stringify(inventory));
        }
        
        // Refresh the inventory table and other displays
        renderInventoryTable();
        updateItemCount();
        
        showToast('success', `Listed ${listing.quantity} ${listing.unit} of "${inventoryItem.name}" on marketplace!\nInventory updated: ${inventoryItem.quantity} ${inventoryItem.unit} remaining`);
      }
      
      // Reset form and update display
      e.target.reset();
      document.getElementById('productDetails').style.display = 'none';
      
      // Refresh quick list dropdown to show updated inventory
      populateQuickList();
    }

    // Calculate profit
    function calculateProfit() {
      const price = parseFloat(document.querySelector('input[name="price"]').value) || 0;
      const cost = parseFloat(document.querySelector('input[name="cost"]').value) || 0;
      const profit = price - cost;
      const profitPercent = cost > 0 ? ((profit / cost) * 100).toFixed(1) : 0;

      const indicator = document.getElementById('profitIndicator');
      if (profit > 0) {
        indicator.innerHTML = `<i class="fas fa-arrow-up text-success"></i> Profit: R${profit.toFixed(2)} (${profitPercent}%)`;
        indicator.className = 'profit-indicator profit-positive';
      } else if (profit < 0) {
        indicator.innerHTML = `<i class="fas fa-arrow-down text-danger"></i> Loss: R${Math.abs(profit).toFixed(2)} (${Math.abs(profitPercent)}%)`;
        indicator.className = 'profit-indicator profit-negative';
      } else {
        indicator.innerHTML = '';
      }
    }

    // Helper function to calculate days until expiry
    function getDaysUntilExpiry(expiryDate) {
      if (!expiryDate) return Infinity;
      const today = new Date();
      const expiry = new Date(expiryDate);
      const timeDiff = expiry - today;
      return Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
    }

    // Populate quick list dropdown
    function populateQuickList() {
      updateQuickListOptions();
    }

    // Clear marketplace form
    function clearMarketplaceForm() {
      document.getElementById('quickListForm').reset();
      document.getElementById('productDetails').style.display = 'none';
    }

    // View marketplace
    function viewMarketplace() {
      window.open('shop.html', '_blank');
    }

    // View analytics
    function viewAnalytics() {
      window.open('analytics.html', '_blank');
    }

    // Show product details in quick list
    function showProductDetails() {
      const select = document.querySelector('select[name="inventoryId"]');
      const productDetails = document.getElementById('productDetails');
      const inventoryId = parseInt(select.value);
      
      if (!inventoryId) {
        productDetails.style.display = 'none';
        return;
      }

      const item = inventory.find(item => item.id === inventoryId);
      if (!item) return;

      const maxQuantity = item.quantity;
      const costPrice = item.costPrice || 0;
      const sellingPrice = item.sellingPrice || item.price || 0;
      const potentialProfit = sellingPrice - costPrice;
      const profitPercent = costPrice > 0 ? ((potentialProfit / costPrice) * 100).toFixed(1) : 0;

      // Update quantity field max
      document.querySelector('input[name="quantity"]').max = maxQuantity;
      document.querySelector('input[name="quantity"]').value = Math.min(1, maxQuantity);
      
      // Update price field with current selling price
      document.querySelector('input[name="price"]').value = sellingPrice.toFixed(2);

      // Check if already listed
      const existingListing = marketplaceItems.find(listing => 
        listing.originalInventoryId === inventoryId && listing.name === item.name
      );

      let listingStatus = '';
      if (existingListing) {
        listingStatus = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-1"></i>
            <strong>Already Listed:</strong> ${existingListing.quantity} ${existingListing.unit} currently on marketplace<br>
            <strong>Current Price:</strong> $${existingListing.sellingPrice} per ${existingListing.unit}
          </div>
        `;
      }

      // Calculate potential revenue
      const estimatedRevenue = maxQuantity * sellingPrice;
      const estimatedProfit = maxQuantity * potentialProfit;

      // Show expiry warning if applicable
      let expiryInfo = '';
      if (item.expiryDate) {
        const daysUntilExpiry = getDaysUntilExpiry(item.expiryDate);
        if (daysUntilExpiry <= 7) {
          const urgencyClass = daysUntilExpiry <= 3 ? 'alert-danger' : 'alert-warning';
          const urgencyIcon = daysUntilExpiry <= 3 ? 'fa-exclamation-circle' : 'fa-clock';
          expiryInfo = `
            <div class="alert ${urgencyClass}">
              <i class="fas ${urgencyIcon} me-1"></i>
              <strong>Expiry Notice:</strong> ${daysUntilExpiry <= 0 ? 'Expired!' : `Expires in ${daysUntilExpiry} day${daysUntilExpiry !== 1 ? 's' : ''}`}
            </div>
          `;
        }
      }

      // Show details
      productDetails.innerHTML = `
        <div class="alert alert-info">
          <div class="row">
            <div class="col-md-6">
              <strong>Available:</strong> ${item.quantity} ${item.unit}<br>
              <strong>Category:</strong> ${item.category}
            </div>
            <div class="col-md-6">
              <strong>Cost Price:</strong> $${costPrice.toFixed(2)}<br>
              <strong>Selling Price:</strong> $${sellingPrice.toFixed(2)}
            </div>
          </div>
          ${potentialProfit > 0 ? 
            `<div class="mt-2"><strong>Profit Potential:</strong> $${potentialProfit.toFixed(2)} per unit (${profitPercent}%)</div>` : 
            ''
          }
        </div>
        ${expiryInfo}
        ${listingStatus}
        <div class="mt-2">
          <small class="text-muted">
            <strong>Potential Revenue:</strong> $${estimatedRevenue.toFixed(2)} 
            ${estimatedProfit > 0 ? `| <strong>Potential Profit:</strong> $${estimatedProfit.toFixed(2)}` : ''}
          </small>
        </div>
      `;
      productDetails.style.display = 'block';
    }

    // Render inventory table
    function renderInventoryTable() {
      const tbody = document.getElementById('inventoryTableBody');
      const emptyState = document.getElementById('emptyState');
      const table = document.getElementById('inventoryTable');
      
      if (inventory.length === 0) {
        emptyState.style.display = 'block';
        table.style.display = 'none';
        return;
      }

      emptyState.style.display = 'none';
      table.style.display = 'table';
      
      tbody.innerHTML = inventory.map(item => {
        const profit = item.price - item.cost;
        const profitClass = profit >= 0 ? 'text-success' : 'text-danger';
        const profitIcon = profit >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
        
        const expiryStatus = getExpiryStatus(item.expiry);
        
        return `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="product-icon category-${item.category.toLowerCase()}">
                  ${getCategoryIcon(item.category)}
                </div>
                <div>
                  <div class="fw-bold">${item.name}</div>
                  <small class="text-muted">${item.unit}</small>
                </div>
              </div>
            </td>
            <td>
              <span class="badge bg-light text-dark">${item.category}</span>
            </td>
            <td>
              <span class="quantity-badge">${item.quantity}</span>
            </td>
            <td>
              <span class="price-chip">R${item.price.toFixed(2)}</span>
            </td>
            <td>
              <span class="${profitClass}">
                <i class="fas ${profitIcon} me-1"></i>
                R${profit.toFixed(2)}
              </span>
            </td>
            <td>
              <span class="${expiryStatus.class}">
                ${expiryStatus.text}
              </span>
            </td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-danger" onclick="deleteInventoryItem(${item.id})">
                <i class="fas fa-trash me-1"></i>Delete
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Get category icon
    function getCategoryIcon(category) {
      const icons = {
        'Grain': 'üåæ',
        'Veg': 'ü•¨',
        'Dairy': 'ü•õ',
        'Meat': 'ü•©',
        'Poultry': 'üêî',
        'Herbs': 'üåø',
        'Other': 'üì¶'
      };
      return icons[category] || 'üì¶';
    }

    // Get expiry status
    function getExpiryStatus(expiryDate) {
      if (!expiryDate) {
        return { class: 'text-muted', text: 'No expiry' };
      }
      
      const expiry = new Date(expiryDate);
      const today = new Date();
      const diffTime = expiry - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays < 0) {
        return { class: 'expiry-warning', text: 'Expired' };
      } else if (diffDays <= 3) {
        return { class: 'expiry-warning', text: `${diffDays}d left` };
      } else {
        return { class: 'expiry-safe', text: `${diffDays}d` };
      }
    }

    // Delete inventory item
    function deleteInventoryItem(id) {
      if (confirm('Are you sure you want to delete this item?')) {
        inventory = inventory.filter(item => item.id !== id);
        if (window.F2CDB && typeof F2CDB.writeInventory === 'function') {
          F2CDB.writeInventory(inventory);
        } else {
          localStorage.setItem('inventory', JSON.stringify(inventory));
        }
        
        showToast('success', 'Item deleted successfully!');
        renderInventoryTable();
        updateQuickListOptions();
        updateItemCount();
      }
    }

    // Update quick list options
    function updateQuickListOptions() {
      const select = document.querySelector('select[name="inventoryId"]');
      const currentValue = select.value;
      
      select.innerHTML = `
        <option value="" disabled selected>Select from inventory...</option>
        ${inventory.map(item => {
          // Check if item is already listed
          const existingListing = marketplaceItems.find(listing => 
            listing.originalInventoryId === item.id && listing.name === item.name
          );
          
          const status = existingListing ? ' [Listed]' : '';
          return `<option value="${item.id}">${item.name} (${item.quantity} ${item.unit})${status}</option>`;
        }).join('')}
      `;
      
      // Try to restore previous selection
      if (currentValue && inventory.find(item => item.id == currentValue)) {
        select.value = currentValue;
      }
    }

    // Update item count
    function updateItemCount() {
      const count = inventory.length;
      const badge = document.getElementById('itemCount');
      badge.textContent = `${count} item${count !== 1 ? 's' : ''}`;
    }

    // Add sample data
    function addSampleData() {
      const samples = [
        {
          name: 'Organic Tomatoes',
          category: 'Veg',
          unit: 'kg',
          quantity: 25,
          price: 25.00,
          cost: 18.00,
          expiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        },
        {
          name: 'Fresh Milk',
          category: 'Dairy',
          unit: 'L',
          quantity: 15,
          price: 18.50,
          cost: 12.00,
          expiry: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        },
        {
          name: 'Free-range Eggs',
          category: 'Poultry',
          unit: 'dozen',
          quantity: 8,
          price: 35.00,
          cost: 25.00,
          expiry: ''
        },
        {
          name: 'Basil Herbs',
          category: 'Herbs',
          unit: 'bunch',
          quantity: 12,
          price: 15.00,
          cost: 10.00,
          expiry: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        }
      ];

      samples.forEach(sample => {
        const item = {
          id: Date.now() + Math.random(),
          ...sample,
          createdAt: new Date().toISOString()
        };
        inventory.push(item);
      });

      if (window.F2CDB && typeof F2CDB.writeInventory === 'function') {
        F2CDB.writeInventory(inventory);
      } else {
        localStorage.setItem('inventory', JSON.stringify(inventory));
      }
      
      showToast('success', `Added ${samples.length} sample items!`);
      renderInventoryTable();
      updateQuickListOptions();
      updateItemCount();
    }

    // Show toast notification
    function showToast(type, message) {
      const toastContainer = document.getElementById('toastContainer');
      const toastId = 'toast-' + Date.now();
      
      const toast = document.createElement('div');
      toast.innerHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      const toastElement = new bootstrap.Toast(document.getElementById(toastId));
      toastElement.show();
      
      // Remove toast element after it's hidden
      document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
        toast.remove();
      });
    }
  </script>
</body>
</html>