<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>F2C Solutions ‚Äî Analytics</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link href="../styles/custom.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .analytics-header {
      background: linear-gradient(135deg, #5a8a59 0%, #6b9c6d 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: 0 8px 25px rgba(90, 138, 89, 0.3);
    }
    
    .analytics-header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2.5rem;
      font-weight: 700;
    }
    
    .analytics-header p {
      margin: 0;
      opacity: 0.9;
      font-size: 1.1rem;
    }
    
    .metric-card {
      background: white;
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      height: 100%;
    }
    
    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    
    .metric-card .card-body {
      padding: 1.5rem;
    }
    
    .metric-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 0.5rem;
    }
    
    .metric-label {
      color: #718096;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .section-card {
      background: white;
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
      margin-bottom: 2rem;
    }
    
    .section-card .card-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-bottom: 1px solid #e9ecef;
      padding: 1.5rem;
      font-weight: 600;
      color: #2d3748;
      font-size: 1.2rem;
    }
    
    .section-card .card-body {
      padding: 1.5rem;
    }
    
    .expiry-good { 
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 8px;
      padding: 0.25rem 0.75rem;
      font-weight: 500;
    }
    
    .expiry-warning { 
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 0.25rem 0.75rem;
      font-weight: 500;
    }
    
    .expiry-danger { 
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border: 1px solid #f5c6cb;
      border-radius: 8px;
      padding: 0.25rem 0.75rem;
      font-weight: 500;
    }
    
    .product-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }
    
    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .product-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 0.5rem;
    }
    
    .product-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .order-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border-left: 4px solid #5a8a59;
      transition: all 0.3s ease;
    }
    
    .order-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .order-status {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-pending { background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); color: #856404; }
    .status-confirmed { background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); color: #0c5460; }
    .status-shipped { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; }
    .status-delivered { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; }
    
    .chart-container {
      position: relative;
      height: 300px;
      margin: 1rem 0;
    }
    
    .nav-tabs .nav-link {
      border-radius: 8px 8px 0 0;
      font-weight: 500;
    }
    
    .nav-tabs .nav-link.active {
      background-color: #5a8a59;
      border-color: #5a8a59;
      color: white;
    }
  </style>
</head>
<body>
  <!-- Primary navbar (loaded via component) -->
  <div id="navbar"></div>
  
  <!-- Fallback navbar (shown if component loading fails) -->
  <div id="navbar-fallback" style="display: none;">
    <nav class="main-navbar" style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; position: sticky; top: 0; z-index: 1000;">
      <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; min-height: 80px;">
        <div style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: #333;">
          <div style="width: 40px; height: 40px; background-color: #5a8a59; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">F2C</div>
          <div>
            <h1 style="font-size: 18px; font-weight: 700; color: #333; margin: 0;">F2C Solutions</h1>
            <p style="font-size: 12px; color: #666; margin: 0;">Farmer to Customer</p>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <a href="../html/dashboard.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Dashboard</a>
          <a href="../html/inventory.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Inventory</a>
          <a href="../html/analytics.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px; background-color: #5a8a59; color: white;">Analytics</a>
          <a href="../html/shop.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Marketplace</a>
          <a href="../html/tracking.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Orders</a>
          <a href="../html/auth.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Profile</a>
        </div>
      </div>
    </nav>
  </div>

  <main class="container my-4">
    <!-- Header -->
    <div class="analytics-header">
      <h1><i class="fas fa-chart-line me-3"></i>Analytics & Insights</h1>
      <p>Track your farm's performance, listed products, and customer orders</p>
    </div>

    <!-- Key Metrics -->
    <div class="row g-4 mb-4">
      <div class="col-lg-3 col-md-6">
        <div class="metric-card">
          <div class="card-body text-center">
            <div class="metric-icon mx-auto" style="background: linear-gradient(135deg, #5a8a59 0%, #6b9c6d 100%); color: white;">
              <i class="fas fa-boxes"></i>
            </div>
            <div class="metric-value" id="totalProducts">0</div>
            <div class="metric-label">Products Listed</div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="metric-card">
          <div class="card-body text-center">
            <div class="metric-icon mx-auto" style="background: linear-gradient(135deg, #6c757d 0%, #868e96 100%); color: white;">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="metric-value" id="totalOrders">0</div>
            <div class="metric-label">Total Orders</div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="metric-card">
          <div class="card-body text-center">
            <div class="metric-icon mx-auto" style="background: linear-gradient(135deg, #28a745 0%, #34ce57 100%); color: white;">
              <i class="fas fa-coins"></i>
            </div>
            <div class="metric-value" id="totalRevenue">R0</div>
            <div class="metric-label">Total Revenue</div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="metric-card">
          <div class="card-body text-center">
            <div class="metric-icon mx-auto" style="background: linear-gradient(135deg, #dc3545 0%, #e5566d 100%); color: white;">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="metric-value" id="expiringSoon">0</div>
            <div class="metric-label">Expiring Soon</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="row g-4 mb-4">
      <div class="col-lg-6">
        <div class="section-card">
          <div class="card-header">
            <i class="fas fa-chart-bar me-2"></i>Sales by Category
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-6">
        <div class="section-card">
          <div class="card-header">
            <i class="fas fa-chart-line me-2"></i>Monthly Revenue Trend
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Detailed Analytics -->
    <div class="section-card">
      <div class="card-header">
        <i class="fas fa-list me-2"></i>Detailed Analytics
      </div>
      <div class="card-body">
        <ul class="nav nav-tabs mb-4" id="analyticsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
              <i class="fas fa-boxes me-2"></i>Listed Products
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
              <i class="fas fa-shopping-cart me-2"></i>Customer Orders
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="expiry-tab" data-bs-toggle="tab" data-bs-target="#expiry" type="button" role="tab">
              <i class="fas fa-calendar-times me-2"></i>Expiry Tracking
            </button>
          </li>
        </ul>
        
        <div class="tab-content" id="analyticsTabContent">
          <!-- Listed Products Tab -->
          <div class="tab-pane fade show active" id="products" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Listed Products</h5>
              <div>
                <button class="btn btn-outline-success btn-sm me-2" onclick="exportProducts()">
                  <i class="fas fa-download me-1"></i>Export
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshProducts()">
                  <i class="fas fa-sync me-1"></i>Refresh
                </button>
              </div>
            </div>
            <div id="productsList">
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading your listed products...</p>
              </div>
            </div>
          </div>
          
          <!-- Orders Tab -->
          <div class="tab-pane fade" id="orders" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Customer Orders</h5>
              <div>
                <button class="btn btn-outline-success btn-sm me-2" onclick="exportOrders()">
                  <i class="fas fa-download me-1"></i>Export
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshOrders()">
                  <i class="fas fa-sync me-1"></i>Refresh
                </button>
              </div>
            </div>
            <div id="ordersList">
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading customer orders...</p>
              </div>
            </div>
          </div>
          
          <!-- Expiry Tracking Tab -->
          <div class="tab-pane fade" id="expiry" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Expiry Tracking</h5>
              <div>
                <select class="form-select form-select-sm me-2" id="expiryFilter" style="width: auto; display: inline-block;" onchange="filterExpiryItems()">
                  <option value="all">All Items</option>
                  <option value="expired">Expired</option>
                  <option value="expiring">Expiring Soon (‚â§7 days)</option>
                  <option value="fresh">Fresh (>7 days)</option>
                </select>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshExpiry()">
                  <i class="fas fa-sync me-1"></i>Refresh
                </button>
              </div>
            </div>
            <div id="expiryList">
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading expiry information...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/components.js"></script>
  <script src="../js/db.js"></script>
  <script>
    console.log('Loading navbar component...');
    
    // Load navbar component with error handling
    loadComponent("navbar", "../components/navbar.html").then(() => {
      console.log('Navbar component loaded successfully');
      // Hide fallback navbar if main navbar loaded successfully
      const fallback = document.getElementById('navbar-fallback');
      if (fallback) {
        fallback.style.display = 'none';
      }
    }).catch((error) => {
      console.error('Failed to load navbar component:', error);
      
      // Show fallback navbar
      const fallback = document.getElementById('navbar-fallback');
      if (fallback) {
        fallback.style.display = 'block';
        console.log('Fallback navbar shown');
      }
      
      // Try fallback method
      fetch('../components/navbar.html')
        .then(response => response.text())
        .then(html => {
          const navbarElement = document.getElementById('navbar');
          if (navbarElement) {
            navbarElement.innerHTML = html;
            console.log('Navbar loaded via fallback method');
            // Hide fallback navbar if successful
            const fallback = document.getElementById('navbar-fallback');
            if (fallback) {
              fallback.style.display = 'none';
            }
          }
        })
        .catch(fallbackError => {
          console.error('Fallback navbar loading failed:', fallbackError);
        });
    });

    // Initialize analytics when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initializeAnalytics();
      setTimeout(() => {
        updateAnalytics();
      }, 500);
    });

    // Listen for ordersUpdated events triggered by marketplace/checkout
    window.addEventListener('ordersUpdated', function() {
      updateAnalytics();
    });

    function initializeAnalytics() {
      // Initialize orders if not exist
      let orders = JSON.parse(localStorage.getItem('orders')) || [];
      if (orders.length === 0) {
        // Create sample orders for demonstration
        orders = [
          {
            id: Date.now(),
            customerName: "Sarah Johnson",
            customerEmail: "sarah@email.com",
            products: [
              { name: "Organic Tomatoes", quantity: 2, price: 4.50 },
              { name: "Fresh Milk", quantity: 1, price: 3.25 }
            ],
            totalAmount: 12.25,
            orderDate: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
            status: "confirmed",
            shippingAddress: "123 Main St, Springfield, IL 62701"
          },
          {
            id: Date.now() - 1,
            customerName: "Mike Chen",
            customerEmail: "mike@email.com",
            products: [
              { name: "Free Range Eggs", quantity: 1, price: 6.00 }
            ],
            totalAmount: 6.00,
            orderDate: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
            status: "shipped",
            shippingAddress: "456 Oak Ave, Springfield, IL 62702"
          },
          {
            id: Date.now() - 2,
            customerName: "Emily Davis",
            customerEmail: "emily@email.com",
            products: [
              { name: "Organic Lettuce", quantity: 1, price: 2.75 },
              { name: "Fresh Spinach", quantity: 1, price: 3.50 }
            ],
            totalAmount: 6.25,
            orderDate: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
            status: "pending",
            shippingAddress: "789 Pine St, Springfield, IL 62703"
          }
        ];
        localStorage.setItem('orders', JSON.stringify(orders));
      }
    }

    function updateAnalytics() {
      updateMetrics();
      updateProductsList();
      updateOrdersList();
      updateExpiryTracking();
      updateCharts();
    }

    function updateMetrics() {
      const marketplaceItems = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      const inventory = window.F2CDB ? F2CDB.readInventory() : (JSON.parse(localStorage.getItem('inventory')) || []);
      
      // Total products listed
      document.getElementById('totalProducts').textContent = marketplaceItems.length;
      
      // Total orders
      document.getElementById('totalOrders').textContent = orders.length;
      
      // Total revenue
      const totalRevenue = orders.reduce((sum, order) => sum + (order.totalAmount || order.total || 0), 0);
      document.getElementById('totalRevenue').textContent = 'R' + totalRevenue.toFixed(2);
      
      // Expiring soon (within 7 days)
      const expiringSoon = inventory.filter(item => {
        if (!item.expiryDate) return false;
        const expiryDate = new Date(item.expiryDate);
        const today = new Date();
        const daysDiff = (expiryDate - today) / (1000 * 60 * 60 * 24);
        return daysDiff <= 7 && daysDiff >= 0;
      }).length;
      document.getElementById('expiringSoon').textContent = expiringSoon;
    }

    function updateProductsList() {
      const marketplaceItems = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      const container = document.getElementById('productsList');
      
      if (marketplaceItems.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No products listed yet</h5>
            <p class="text-muted">Start by adding items to your marketplace from the inventory page.</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      marketplaceItems.forEach(item => {
        const categoryEmoji = {
          'üåæ Grains & Seeds': 'üåæ',
          'üåø Herbs': 'üåø',
          'ü•¨ Vegetables': 'ü•¨',
          'ü•õ Dairy': 'ü•õ',
          'ü•© Meat': 'ü•©',
          'üêî Poultry': 'üêî',
          'üì¶ Other': 'üì¶'
        };
        
        html += `
          <div class="product-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="product-title">
                ${categoryEmoji[item.category] || 'üì¶'} ${item.name}
              </div>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="editProduct(${item.id})" title="Edit Product">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="removeFromMarketplace(${item.id})" title="Remove from Marketplace">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="product-details">
              <div>
                <small class="text-muted">${item.category}</small><br>
                <strong>R${item.sellingPrice}/${item.unit}</strong>
              </div>
              <div class="text-end">
                <span class="badge bg-success">${item.quantity} ${item.unit}</span><br>
                ${item.expiryDate ? getExpiryBadge(item.expiryDate) : ''}
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function updateOrdersList() {
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      const container = document.getElementById('ordersList');
      
      if (orders.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No orders yet</h5>
            <p class="text-muted">Customer orders will appear here when they make purchases.</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      orders.sort((a, b) => new Date(b.orderDate || b.date || b.order_date || 0) - new Date(a.orderDate || a.date || a.order_date || 0));

      orders.forEach(order => {
        const orderDate = new Date(order.orderDate || order.date || order.order_date || Date.now()).toLocaleDateString();
        const status = (order.status || '').toString();
        const statusClass = `status-${status.toLowerCase()}`;

        // customer fields may be top-level or nested
        const customerName = order.customerName || (order.customer && order.customer.name) || '';
        const customerEmail = order.customerEmail || (order.customer && order.customer.email) || '';

        const totalVal = (order.totalAmount || order.total || 0);
        const items = order.products || order.items || [];

        const actionButtons = getOrderActionButtons(order);
        html += `
          <div class="order-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="mb-1">Order #${order.id}</h6>
                <small class="text-muted">${customerName} ‚Ä¢ ${customerEmail}</small>
              </div>
              <div class="text-end">
                <span class="order-status ${statusClass}">${status.toUpperCase()}</span><br>
                <small class="text-muted">R${totalVal.toFixed(2)}</small>
              </div>
            </div>
            <div class="mb-2">
              <strong>Items:</strong>
              ${items.map(product => 
                `${product.name} (${product.quantity}x R${(product.price || product.sellingPrice || 0)})`
              ).join(', ')}
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                <i class="fas fa-calendar me-1"></i>${orderDate} ‚Ä¢ 
                <i class="fas fa-map-marker-alt me-1"></i>${order.shippingAddress || ''}
              </small>
              <div class="btn-group btn-group-sm">
                ${actionButtons}
                <button class="btn btn-outline-danger" onclick="deleteOrder(${order.id})" title="Delete Order">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function updateExpiryTracking() {
      filterExpiryItems();
    }

    function getDaysUntilExpiry(expiryDate) {
      const today = new Date();
      const expiry = new Date(expiryDate);
      const timeDiff = expiry - today;
      return Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
    }

    function getExpiryBadgeClass(days) {
      if (days < 0) return 'bg-danger text-white';
      if (days <= 3) return 'expiry-danger';
      if (days <= 7) return 'expiry-warning';
      return 'expiry-good';
    }

    function getUrgencyText(days) {
      if (days < 0) return `Expired ${Math.abs(days)} days ago`;
      if (days === 0) return 'Expires today';
      if (days === 1) return 'Expires tomorrow';
      if (days <= 3) return `Expires in ${days} days`;
      if (days <= 7) return `Expires in ${days} days`;
      return `Expires in ${days} days`;
    }

    function getExpiryBadge(expiryDate) {
      const days = getDaysUntilExpiry(expiryDate);
      const badgeClass = getExpiryBadgeClass(days);
      const urgencyText = getUrgencyText(days);
      return `<span class="badge ${badgeClass}">${urgencyText}</span>`;
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function getOrderActionButtons(order) {
      const buttons = [];
      const s = (order.status || '').toString().toLowerCase();

      if (s === 'pending') {
        buttons.push(`<button class="btn btn-success btn-sm" onclick="updateOrderStatus(${order.id}, 'confirmed')" title="Confirm Order">
          <i class="fas fa-check"></i> Confirm
        </button>`);
      }

      if (s === 'confirmed') {
        buttons.push(`<button class="btn btn-primary btn-sm" onclick="updateOrderStatus(${order.id}, 'shipped')" title="Mark as Shipped">
          <i class="fas fa-truck"></i> Ship
        </button>`);
      }

      if (s === 'shipped') {
        buttons.push(`<button class="btn btn-info btn-sm" onclick="updateOrderStatus(${order.id}, 'delivered')" title="Mark as Delivered">
          <i class="fas fa-check-circle"></i> Delivered
        </button>`);
      }

      return buttons.join('');
    }

    function updateOrderStatus(orderId, newStatus) {
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      const orderIndex = orders.findIndex(order => order.id == orderId);

      if (orderIndex === -1) {
        showToast('Order not found', 'error');
        return;
      }

      const normalized = (newStatus || '').toString().toLowerCase();
      orders[orderIndex].status = normalized;
      localStorage.setItem('orders', JSON.stringify(orders));

      const statusMessages = {
        'confirmed': 'Order confirmed successfully!',
        'shipped': 'Order marked as shipped!',
        'delivered': 'Order marked as delivered!'
      };

      showToast(statusMessages[normalized] || 'Order status updated', 'success');
      updateAnalytics();
    }

    function deleteOrder(orderId) {
      if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
        return;
      }
      
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      const filteredOrders = orders.filter(order => order.id != orderId);
      localStorage.setItem('orders', JSON.stringify(filteredOrders));
      
      showToast('Order deleted successfully', 'info');
      updateAnalytics();
    }

    function exportOrders() {
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      
      if (orders.length === 0) {
        showToast('No orders to export', 'warning');
        return;
      }
      
      const csvContent = "data:text/csv;charset=utf-8," 
        + "Order ID,Customer Name,Customer Email,Total Amount,Status,Order Date,Shipping Address\n"
        + orders.map(order => {
          const custName = order.customerName || (order.customer && order.customer.name) || '';
          const custEmail = order.customerEmail || (order.customer && order.customer.email) || '';
          const totalVal = (order.totalAmount || order.total || 0);
          const dateStr = new Date(order.orderDate || order.date || order.order_date || Date.now()).toLocaleDateString();
          return [
            order.id,
            `"${custName}"`,
            `"${custEmail}"`,
            totalVal,
            order.status,
            dateStr,
            `"${order.shippingAddress || ''}"`
          ].join(',');
        }).join('\n');
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `orders_export_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('Orders exported successfully', 'success');
    }

    function refreshOrders() {
      updateAnalytics();
      showToast('Orders refreshed', 'info');
    }

    function editProduct(productId) {
      const marketplaceItems = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      const product = marketplaceItems.find(item => item.id == productId);
      
      if (!product) {
        showToast('Product not found', 'error');
        return;
      }
      
      const newPrice = prompt(`Enter new price for ${product.name} (current: R${product.sellingPrice}):`, product.sellingPrice);
      if (newPrice === null) return; // User cancelled
      
      const newQuantity = prompt(`Enter new quantity for ${product.name} (current: ${product.quantity} ${product.unit}):`, product.quantity);
      if (newQuantity === null) return; // User cancelled
      
      const price = parseFloat(newPrice);
      const quantity = parseInt(newQuantity);
      
      if (isNaN(price) || price <= 0) {
        showToast('Invalid price', 'error');
        return;
      }
      
      if (isNaN(quantity) || quantity < 0) {
        showToast('Invalid quantity', 'error');
        return;
      }
      
      product.sellingPrice = price;
      product.quantity = quantity;
      
      if (quantity === 0) {
        // Remove product if quantity is 0
        const index = marketplaceItems.findIndex(item => item.id == productId);
        marketplaceItems.splice(index, 1);
        showToast(`${product.name} removed from marketplace (out of stock)`, 'info');
      } else {
        showToast(`${product.name} updated successfully`, 'success');
      }
      
      if (window.F2CDB) {
        F2CDB.writeMarketplace(marketplaceItems);
      } else {
        localStorage.setItem('marketplaceItems', JSON.stringify(marketplaceItems));
      }
      updateAnalytics();
    }

    function removeFromMarketplace(productId) {
      const marketplaceItems = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      const product = marketplaceItems.find(item => item.id == productId);
      
      if (!product) {
        showToast('Product not found', 'error');
        return;
      }
      
      if (!confirm(`Are you sure you want to remove "${product.name}" from the marketplace?`)) {
        return;
      }
      
      const filteredItems = marketplaceItems.filter(item => item.id != productId);
      if (window.F2CDB) {
        F2CDB.writeMarketplace(filteredItems);
      } else {
        localStorage.setItem('marketplaceItems', JSON.stringify(filteredItems));
      }
      
      showToast(`${product.name} removed from marketplace`, 'info');
      updateAnalytics();
    }

    function exportProducts() {
      const marketplaceItems = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      
      if (marketplaceItems.length === 0) {
        showToast('No products to export', 'warning');
        return;
      }
      
      const csvContent = "data:text/csv;charset=utf-8," 
        + "Product Name,Category,Quantity,Unit,Price per Unit,Total Value\n"
        + marketplaceItems.map(item => {
          return [
            `"${item.name}"`,
            `"${item.category}"`,
            item.quantity,
            `"${item.unit}"`,
            item.sellingPrice,
            (item.quantity * item.sellingPrice).toFixed(2)
          ].join(',');
        }).join('\n');
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `products_export_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('Products exported successfully', 'success');
    }

    function refreshProducts() {
      updateAnalytics();
      showToast('Products refreshed', 'info');
    }

    function filterExpiryItems() {
      const filter = document.getElementById('expiryFilter').value;
      const inventory = window.F2CDB ? F2CDB.readInventory() : (JSON.parse(localStorage.getItem('inventory')) || []);
      const container = document.getElementById('expiryList');
      
      const itemsWithExpiry = inventory.filter(item => item.expiryDate);
      
      if (itemsWithExpiry.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No expiry dates set</h5>
            <p class="text-muted">Add expiry dates to your inventory items for tracking.</p>
          </div>
        `;
        return;
      }
      
      let filteredItems = itemsWithExpiry;
      
      if (filter !== 'all') {
        filteredItems = itemsWithExpiry.filter(item => {
          const days = getDaysUntilExpiry(item.expiryDate);
          switch (filter) {
            case 'expired': return days < 0;
            case 'expiring': return days >= 0 && days <= 7;
            case 'fresh': return days > 7;
            default: return true;
          }
        });
      }
      
      if (filteredItems.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="fas fa-filter fa-2x text-muted mb-3"></i>
            <h5 class="text-muted">No items match the selected filter</h5>
            <p class="text-muted">Try selecting a different filter option.</p>
          </div>
        `;
        return;
      }
      
      // Sort by expiry date (earliest first)
      filteredItems.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
      
      let html = '';
      filteredItems.forEach(item => {
        const daysDiff = getDaysUntilExpiry(item.expiryDate);
        const badgeClass = getExpiryBadgeClass(daysDiff);
        const urgencyText = getUrgencyText(daysDiff);
        
        html += `
          <div class="product-card">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="product-title">${item.name}</div>
                <small class="text-muted">${item.category} ‚Ä¢ ${item.quantity} ${item.unit}</small>
              </div>
              <div class="text-end">
                <span class="badge ${badgeClass} mb-1">${urgencyText}</span><br>
                <small class="text-muted">
                  <i class="fas fa-calendar me-1"></i>${formatDate(item.expiryDate)}
                </small>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function refreshExpiry() {
      updateAnalytics();
      document.getElementById('expiryFilter').value = 'all';
      showToast('Expiry data refreshed', 'info');
    }

    function updateCharts() {
      // Category Chart
      const ctx1 = document.getElementById('categoryChart').getContext('2d');
      const marketplaceItems = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
      
      // Group by category
      const categoryData = {};
      marketplaceItems.forEach(item => {
        categoryData[item.category] = (categoryData[item.category] || 0) + item.quantity;
      });
      
      new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: Object.keys(categoryData),
          datasets: [{
            data: Object.values(categoryData),
            backgroundColor: [
              '#5a8a59',
              '#6b9c6d',
              '#7dc47d',
              '#8fd48f',
              '#a0e0a1',
              '#b1ecb3',
              '#c2f8c5'
            ],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Revenue Chart
      const ctx2 = document.getElementById('revenueChart').getContext('2d');
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      
      // Generate monthly revenue data
      const monthlyData = Array(12).fill(0);
      orders.forEach(order => {
        const month = new Date(order.orderDate || order.date || order.order_date || Date.now()).getMonth();
        monthlyData[month] += (order.totalAmount || order.total || 0);
      });
      
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      new Chart(ctx2, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
              label: 'Revenue (R)',
            data: monthlyData,
            borderColor: '#5a8a59',
            backgroundColor: 'rgba(90, 138, 89, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'R' + value;
                  }
                }
            }
          }
        }
      });
    }
  </script>
</body>
</html>