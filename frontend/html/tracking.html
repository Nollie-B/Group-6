<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>F2C Solutions â€” Orders Management</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../styles/custom.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/chart.js" rel="stylesheet">
  <style>
    .order-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .order-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .order-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .order-id {
      font-size: 1.1rem;
      font-weight: 600;
      color: #343a40;
    }
    
    .order-date {
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    .order-items {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      color: #343a40;
      padding-top: 12px;
      border-top: 2px solid #dee2e6;
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .status-confirmed {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    
    .status-shipped {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status-delivered {
      background-color: #e2e3e5;
      color: #383d41;
    }
    
    .action-btn {
      padding: 6px 12px;
      font-size: 0.75rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 8px;
    }
    
    .btn-confirm {
      background-color: #0d6efd;
      color: white;
    }
    
    .btn-confirm:hover {
      background-color: #0b5ed7;
    }
    
    .btn-ship {
      background-color: #198754;
      color: white;
    }
    
    .btn-ship:hover {
      background-color: #146c43;
    }
    
    .btn-deliver {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-deliver:hover {
      background-color: #5c636a;
    }
    
    .btn-delete {
      background-color: #dc3545;
      color: white;
    }
    
    .btn-delete:hover {
      background-color: #c82333;
    }
    
    .stats-card {
      background: linear-gradient(135deg, #5a8a59 0%, #4a7c47 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .stats-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .stats-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #e9ecef;
      height: 300px;
      margin-bottom: 20px;
    }
    
    .export-section {
      background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
      border: 1px solid #fed7d7;
      border-radius: 12px;
      padding: 20px;
    }
    
    .export-btn {
      background: linear-gradient(135deg, #5a8a59 0%, #4a7c47 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .export-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(90, 138, 89, 0.3);
    }
    
    .import-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e9ecef;
    }
  </style>
</head>
<body>
  <!-- Primary navbar (loaded via component) -->
  <div id="navbar"></div>
  
  <!-- Fallback navbar (shown if component loading fails) -->
  <div id="navbar-fallback" style="display: none;">
    <nav class="main-navbar" style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; position: sticky; top: 0; z-index: 1000;">
      <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; min-height: 80px;">
        <div style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: #333;">
          <div style="width: 40px; height: 40px; background-color: #5a8a59; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">F2C</div>
          <div>
            <h1 style="font-size: 18px; font-weight: 700; color: #333; margin: 0;">F2C Solutions</h1>
            <p style="font-size: 12px; color: #666; margin: 0;">Farmer to Customer</p>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <a href="../html/dashboard.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Dashboard</a>
          <a href="../html/inventory.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Inventory</a>
          <a href="../html/analytics.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Analytics</a>
          <a href="../html/shop.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Marketplace</a>
          <a href="../html/tracking.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px; background-color: #5a8a59; color: white;">Orders</a>
          <a href="../html/auth.html" style="padding: 12px 16px; text-decoration: none; color: #666; border-radius: 8px;">Profile</a>
        </div>
      </div>
    </nav>
  </div>

  <main class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="h2 mb-1">Orders Management</h1>
            <p class="text-muted mb-0">Track and manage all customer orders</p>
          </div>
          <div>
            <button class="btn btn-outline-success me-2" onclick="refreshOrders()">
              <i class="fas fa-sync me-2"></i>Refresh
            </button>
            <button class="btn btn-success" onclick="showAddOrderModal()">
              <i class="fas fa-plus me-2"></i>Add Order
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistics Row -->
    <div class="row g-4 mb-4">
      <div class="col-lg-3 col-md-6">
        <div class="stats-card">
          <div class="stats-value" id="totalOrders">0</div>
          <div class="stats-label">Total Orders</div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="stats-card">
          <div class="stats-value" id="pendingOrders">0</div>
          <div class="stats-label">Pending Orders</div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="stats-card">
          <div class="stats-value" id="completedOrders">0</div>
          <div class="stats-label">Completed</div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="stats-card">
          <div class="stats-value" id="totalRevenue">R0</div>
          <div class="stats-label">Total Revenue</div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Orders List -->
      <div class="col-lg-8">
        <div class="order-card">
          <h3 class="h5 mb-3">Recent Orders</h3>
          <div id="ordersContainer">
            <div class="text-center text-muted py-4">
              <i class="fas fa-shopping-cart fa-3x mb-3"></i>
              <p>No orders found</p>
              <small>Orders will appear here when customers make purchases</small>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Analytics & Export -->
      <div class="col-lg-4">
        <!-- Order Status Chart -->
        <div class="chart-container">
          <div class="chart-title mb-3">Order Status Distribution</div>
          <canvas id="orderStatusChart"></canvas>
        </div>

        <!-- Export/Import Section -->
        <div class="export-section">
          <h4 class="h6 mb-3">
            <i class="fas fa-download me-2"></i>Data Management
          </h4>
          <p class="text-muted mb-3">Export your order data or import from another device</p>
          
          <div class="d-grid gap-2">
            <button class="export-btn" onclick="exportOrdersData()">
              <i class="fas fa-download me-2"></i>Export Orders JSON
            </button>
            <button class="export-btn" onclick="exportAllData()">
              <i class="fas fa-database me-2"></i>Export All Data
            </button>
          </div>
          
          <div class="import-section">
            <label class="form-label">Import Data</label>
            <input type="file" class="form-control mb-2" id="importFile" accept=".json">
            <div class="d-grid">
              <button class="btn btn-outline-primary" onclick="importData()">
                <i class="fas fa-upload me-2"></i>Import Data
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Order Modal -->
  <div class="modal fade" id="addOrderModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Manual Order</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addOrderForm">
            <div class="mb-3">
              <label class="form-label">Customer Name</label>
              <input type="text" class="form-control" id="customerName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Customer Email</label>
              <input type="email" class="form-control" id="customerEmail" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Customer Phone</label>
              <input type="tel" class="form-control" id="customerPhone" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Items (JSON format)</label>
              <textarea class="form-control" id="orderItems" rows="4" placeholder='[{"name": "Product Name", "quantity": 2, "price": 25.00}]' required></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="addManualOrder()">Add Order</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../js/components.js"></script>
  <script src="../js/db.js"></script>
  <script>
    console.log('Loading navbar component...');
    
    // Load navbar component with error handling
    loadComponent("navbar", "../components/navbar.html").then(() => {
      console.log('Navbar component loaded successfully');
      // Hide fallback navbar if main navbar loaded successfully
      const fallback = document.getElementById('navbar-fallback');
      if (fallback) {
        fallback.style.display = 'none';
      }
    }).catch((error) => {
      console.error('Failed to load navbar component:', error);
      
      // Show fallback navbar
      const fallback = document.getElementById('navbar-fallback');
      if (fallback) {
        fallback.style.display = 'block';
        console.log('Fallback navbar shown');
      }
      
      // Try fallback method
      fetch('../components/navbar.html')
        .then(response => response.text())
        .then(html => {
          const navbarElement = document.getElementById('navbar');
          if (navbarElement) {
            navbarElement.innerHTML = html;
            console.log('Navbar loaded via fallback method');
            // Hide fallback navbar if successful
            const fallback = document.getElementById('navbar-fallback');
            if (fallback) {
              fallback.style.display = 'none';
            }
          }
        })
        .catch(fallbackError => {
          console.error('Fallback navbar loading failed:', fallbackError);
        });
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      loadOrders();
      updateStatistics();
    });

    function loadOrders() {
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      const container = document.getElementById('ordersContainer');
      
      if (orders.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted py-4">
            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
            <p>No orders found</p>
            <small>Orders will appear here when customers make purchases</small>
          </div>
        `;
        return;
      }

      container.innerHTML = orders.reverse().map(order => `
        <div class="order-card">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <div class="order-id">Order #${order.id}</div>
              <div class="order-date">${new Date(order.date).toLocaleDateString()}</div>
            </div>
            <span class="status-badge status-${order.status.toLowerCase()}">${order.status}</span>
          </div>
          
          <div class="order-items">
            ${order.items.map(item => `
              <div class="order-item">
                <span>${item.name} x${item.quantity}</span>
                <span>R${(item.price * item.quantity).toFixed(2)}</span>
              </div>
            `).join('')}
          </div>
          
          <div class="order-total">
            <span>Total</span>
            <span>R${order.total.toFixed(2)}</span>
          </div>
          
          <div class="mt-3">
            <small class="text-muted">Customer: ${order.customer.name} | ${order.customer.email}</small>
          </div>
          
          <div class="mt-3">
            ${getOrderActions(order)}
          </div>
        </div>
      `).join('');
    }

    function getOrderActions(order) {
      const actions = [];
      
      if (order.status === 'Pending') {
        actions.push(`<button class="action-btn btn-confirm" onclick="updateOrderStatus(${order.id}, 'Confirmed')">Confirm</button>`);
      }
      
      if (order.status === 'Confirmed') {
        actions.push(`<button class="action-btn btn-ship" onclick="updateOrderStatus(${order.id}, 'Shipped')">Ship</button>`);
      }
      
      if (order.status === 'Shipped') {
        actions.push(`<button class="action-btn btn-deliver" onclick="updateOrderStatus(${order.id}, 'Delivered')">Deliver</button>`);
      }
      
      if (order.status !== 'Delivered') {
        actions.push(`<button class="action-btn btn-delete" onclick="deleteOrder(${order.id})">Delete</button>`);
      }
      
      return actions.join('');
    }

    function updateOrderStatus(orderId, newStatus) {
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      const orderIndex = orders.findIndex(o => o.id === orderId);
      
      if (orderIndex !== -1) {
        orders[orderIndex].status = newStatus;
        localStorage.setItem('orders', JSON.stringify(orders));
        
        showToast(`Order #${orderId} updated to ${newStatus}`, 'success');
        loadOrders();
        updateStatistics();
        updateChart();
      }
    }

    function deleteOrder(orderId) {
      if (confirm('Are you sure you want to delete this order?')) {
        const orders = JSON.parse(localStorage.getItem('orders')) || [];
        const filteredOrders = orders.filter(o => o.id !== orderId);
        
        localStorage.setItem('orders', JSON.stringify(filteredOrders));
        
        showToast(`Order #${orderId} deleted`, 'success');
        loadOrders();
        updateStatistics();
        updateChart();
      }
    }

    function updateStatistics() {
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      
      document.getElementById('totalOrders').textContent = orders.length;
      document.getElementById('pendingOrders').textContent = orders.filter(o => o.status === 'Pending').length;
      document.getElementById('completedOrders').textContent = orders.filter(o => o.status === 'Delivered').length;
      
      const totalRevenue = orders
        .filter(o => o.status === 'Delivered')
        .reduce((sum, order) => sum + order.total, 0);
      
      document.getElementById('totalRevenue').textContent = `R${totalRevenue.toFixed(2)}`;
    }

    function refreshOrders() {
      loadOrders();
      updateStatistics();
      updateChart();
      showToast('Orders refreshed', 'info');
    }

    function showAddOrderModal() {
      const modal = new bootstrap.Modal(document.getElementById('addOrderModal'));
      modal.show();
    }

    function addManualOrder() {
      const customerName = document.getElementById('customerName').value;
      const customerEmail = document.getElementById('customerEmail').value;
      const customerPhone = document.getElementById('customerPhone').value;
      const orderItemsText = document.getElementById('orderItems').value;
      
      try {
        const items = JSON.parse(orderItemsText);
        const total = items.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)), 0);

        // Enrich manual items with marketplace id/owner when possible
        const marketplaceItems = window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []);
        const enrichedItems = items.map(i => {
          // Try to find by id or by name+unit
          const match = marketplaceItems.find(m => (i.id && String(m.id) === String(i.id)) || (m.name === i.name && m.unit === i.unit));
          return Object.assign({}, i, {
            id: i.id || (match && match.id) || null,
            owner: (match && (match.owner || null)) || (i.owner || null)
          });
        });

        const orders = JSON.parse(localStorage.getItem('orders')) || [];
        const newOrder = {
          id: Date.now(),
          date: new Date().toISOString(),
          customer: {
            name: customerName,
            email: customerEmail,
            phone: customerPhone
          },
          items: enrichedItems,
          total: total,
          status: 'Pending'
        };
        
        orders.push(newOrder);
        localStorage.setItem('orders', JSON.stringify(orders));
        
        showToast('Manual order added successfully', 'success');
        
        // Close modal and reset form
        const modal = bootstrap.Modal.getInstance(document.getElementById('addOrderModal'));
        modal.hide();
        document.getElementById('addOrderForm').reset();
        
        loadOrders();
        updateStatistics();
        updateChart();
        
      } catch (error) {
        showToast('Invalid JSON format for items', 'error');
      }
    }

    function exportOrdersData() {
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      downloadJSON(orders, 'orders-data.json');
    }

    function exportAllData() {
      const allData = {
        inventory: window.F2CDB ? F2CDB.readInventory() : (JSON.parse(localStorage.getItem('inventory')) || []),
        marketplaceItems: window.F2CDB ? F2CDB.readMarketplace() : (JSON.parse(localStorage.getItem('marketplaceItems')) || []),
        orders: JSON.parse(localStorage.getItem('orders')) || [],
        exportDate: new Date().toISOString()
      };
      downloadJSON(allData, 'f2c-all-data.json');
    }

    function downloadJSON(data, filename) {
      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.click();
      
      URL.revokeObjectURL(url);
      showToast('Data exported successfully', 'success');
    }

    function importData() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showToast('Please select a file to import', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (data.inventory) {
            if (window.F2CDB) {
              F2CDB.writeInventory(data.inventory);
            } else {
              localStorage.setItem('inventory', JSON.stringify(data.inventory));
            }
          }
          if (data.marketplaceItems) {
            if (window.F2CDB) {
              F2CDB.writeMarketplace(data.marketplaceItems);
            } else {
              localStorage.setItem('marketplaceItems', JSON.stringify(data.marketplaceItems));
            }
          }
          if (data.orders) localStorage.setItem('orders', JSON.stringify(data.orders));
          
          showToast('Data imported successfully', 'success');
          fileInput.value = '';
          loadOrders();
          updateStatistics();
          updateChart();
          
        } catch (error) {
          showToast('Invalid JSON file format', 'error');
        }
      };
      reader.readAsText(file);
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    // Initialize chart
    let orderStatusChart = null;

    function updateChart() {
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      const statusCounts = {
        'Pending': 0,
        'Confirmed': 0,
        'Shipped': 0,
        'Delivered': 0
      };
      
      orders.forEach(order => {
        if (statusCounts.hasOwnProperty(order.status)) {
          statusCounts[order.status]++;
        }
      });
      
      const ctx = document.getElementById('orderStatusChart').getContext('2d');
      
      if (orderStatusChart) {
        orderStatusChart.destroy();
      }
      
      orderStatusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(statusCounts),
          datasets: [{
            data: Object.values(statusCounts),
            backgroundColor: [
              '#fff3cd', // Pending - yellow
              '#d1ecf1', // Confirmed - blue
              '#d4edda', // Shipped - green
              '#e2e3e5'  // Delivered - gray
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Initialize chart when page loads
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(updateChart, 1000); // Wait for navbar to load first
    });
  </script>
</body>
</html>